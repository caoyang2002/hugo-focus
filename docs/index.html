<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="description" content="Hugo Focus Theme Documentation" />
        <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
        />
        <title>Hugo Focus</title>

        <!-- æµè§ˆå™¨å›¾æ ‡ -->
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

        <!-- é»˜è®¤ä¸»é¢˜ -->
        <link
            rel="stylesheet"
            href="//cdn.jsdelivr.net/npm/docsify/lib/themes/vue.css"
        />
    </head>

    <body>
        <div id="app">æ­£åœ¨åŠ è½½æ–‡æ¡£...</div>

        <script>
            // è·å–å½“å‰å®Œæ•´url
            const MAIN_URL = window.location.href;
            const extractBaseUrl = (url) => {
                const hashIndex = url.indexOf("#");
                if (hashIndex !== -1) {
                    return url.substring(0, hashIndex);
                }
                return url;
            };

            const BASE_URL_FOR_HASH_ROUTER = extractBaseUrl(MAIN_URL);
            console.log("BASE_URL_FOR_HASH_ROUTER:", BASE_URL_FOR_HASH_ROUTER);

            // è·å–å½“å‰è¯­è¨€
            function getCurrentLanguage() {
                const hash = window.location.hash;

                // æ–¹æ¡ˆ1ï¼šæ›´ç²¾ç¡®çš„åŒ¹é…ï¼ˆæ¨èï¼‰
                const match = hash.match(/^#\/(zh-cn|en|es)(\/|$)/);
                if (match && match[1]) {
                    return match[1];
                }

                // æ–¹æ¡ˆ2ï¼šä½¿ç”¨ includes ä½†æ›´å…¨é¢
                if (hash.startsWith("#/en/") || hash === "#/en") return "en";
                if (hash.startsWith("#/es/") || hash === "#/es") return "es";
                if (hash.startsWith("#/zh-cn/") || hash === "#/zh-cn")
                    return "zh-cn";

                // é»˜è®¤å€¼
                return "zh-cn";
            }

            window.$docsify = {
                loadNavbar: true, // å¿…é¡»ä¸º true
                debug: true,
                // é¡¹ç›®ä¿¡æ¯
                name: "Hugo Focus",
                repo: "https://github.com/caoyang2002/hugo-focus",

                // è®¾ç½®é»˜è®¤é¦–é¡µ
                // homepage: 'zh-cn/README.md',
                homepage: "#",

                // ä¸ä½¿ç”¨ basePath
                basePath: "/",

                // åˆ«åé…ç½®
                alias: {},

                // åŠ è½½é…ç½®
                loadSidebar: true,
                loadNavbar: true,
                coverpage: true,

                // æœç´¢é…ç½®
                search: {
                    maxAge: 86400000,
                    paths: "auto",
                    placeholder: {
                        "/zh-cn/": "æœç´¢",
                        "/en/": "Search",
                        "/es/": "Buscar",
                    },
                    noData: {
                        "/zh-cn/": "æ‰¾ä¸åˆ°ç»“æœ",
                        "/en/": "No results found",
                        "/es/": "No se encontraron resultados",
                    },
                    depth: 3,
                    namespace: "hugo-focus-docs",
                },

                // å…¶ä»–é…ç½®
                maxLevel: 5,
                subMaxLevel: 4,
                sidebarDisplayLevel: 1, // è®¾ç½®ä¾§è¾¹æ åˆå§‹å±•å¼€çš„å±‚çº§
                mergeNavbar: true,
                auto2top: true,
                relativePath: false,

                // è‡ªå®šä¹‰æ’ä»¶
                plugins: [
                    // åˆå§‹åŒ–å’Œé‡å®šå‘
                    // åœ¨ plugins çš„ç¬¬ä¸€ä¸ªæ’ä»¶ä¸­
                    function (hook, vm) {
                        hook.init(function () {
                            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ DOM å‡†å¤‡å°±ç»ª
                            setTimeout(function () {
                                const hash = window.location.hash;
                                const browserLang = (
                                    navigator.language || navigator.userLanguage
                                ).toLowerCase();
                                const savedLang = localStorage.getItem(
                                    "docsify-preferred-language",
                                );

                                let targetLang = savedLang || "zh-cn";
                                if (!savedLang) {
                                    if (browserLang.startsWith("en"))
                                        targetLang = "en";
                                    else if (browserLang.startsWith("es"))
                                        targetLang = "es";
                                }

                                // åªæœ‰å½“å®Œå…¨æ²¡æœ‰hashæˆ–hashä¸ºç©ºæ—¶æ‰é‡å®šå‘
                                if (!hash || hash === "#/" || hash === "#") {
                                    window.location.hash =
                                        "#/" + targetLang + "/";
                                } else if (
                                    !hash.includes("/zh-cn/") &&
                                    !hash.includes("/en/") &&
                                    !hash.includes("/es/")
                                ) {
                                    // å¦‚æœhashä¸­ä¸åŒ…å«ä»»ä½•è¯­è¨€å‰ç¼€ï¼Œæ·»åŠ æ£€æµ‹åˆ°çš„è¯­è¨€
                                    const cleanHash = hash.replace(/^#\/?/, "");
                                    window.location.hash =
                                        "#/" + targetLang + "/" + cleanHash;
                                }
                            }, 0);
                        });
                    },

                    // è‡ªåŠ¨ä¿®æ­£ä¾§è¾¹æ é“¾æ¥ - æ ¸å¿ƒæ’ä»¶
                    function (hook, vm) {
                        console.group("[å¤šè¯­è¨€æ’ä»¶] å¼€å§‹æ‰§è¡Œ");
                        const currentLang = getCurrentLanguage();
                        console.log("ğŸŒ æ£€æµ‹åˆ°å½“å‰è¯­è¨€:", currentLang);
                        console.log("ğŸ“„ å½“å‰è·¯ç”±:", vm.route.path);
                        hook.doneEach(function () {
                            console.log(
                                "å½“å‰ DOM ä¸­ .app-nav æ•°é‡:",
                                document.querySelectorAll(".app-nav").length,
                            );
                            const currentLang = getCurrentLanguage();

                            // ä¿®æ­£ä¾§è¾¹æ é“¾æ¥
                            const sidebar =
                                document.querySelector(".sidebar-nav");
                            // if (sidebar) {
                            //   const links = sidebar.querySelectorAll('a[href]');

                            //   links.forEach(link => {
                            //     let href = link.getAttribute('href');

                            //     // åªå¤„ç†ç›¸å¯¹è·¯å¾„çš„ markdown é“¾æ¥
                            //     if (href && !href.startsWith('http') && !href.startsWith('#/')) {
                            //       // ç§»é™¤å¼€å¤´çš„ # æˆ– /
                            //       href = href.replace(/^#?\/?/, '');

                            //       // å¦‚æœä¸åŒ…å«è¯­è¨€å‰ç¼€ï¼Œæ·»åŠ å½“å‰è¯­è¨€å‰ç¼€
                            //       if (!href.startsWith(currentLang + '/') &&
                            //         !href.startsWith('zh-cn/') &&
                            //         !href.startsWith('en/') &&
                            //         !href.startsWith('es/')) {
                            //         href = currentLang + '/' + href;
                            //       }

                            //       console.log('side bar href: ', href)
                            //       // è®¾ç½®æ–°çš„ href
                            //       link.setAttribute('href', '#/' + href);
                            //     }
                            //   });
                            // }

                            // ä¿®æ­£å¯¼èˆªæ é“¾æ¥
                            // const sidebar = document.querySelector('.sidebar-nav');
                            if (sidebar) {
                                const links =
                                    sidebar.querySelectorAll("a[href]");
                                console.log(
                                    `æ‰¾åˆ° ${links.length} ä¸ªä¾§è¾¹æ é“¾æ¥`,
                                );

                                let fixedCount = 0;
                                let skippedCount = 0;

                                links.forEach((link, index) => {
                                    const originalHref =
                                        link.getAttribute("href");
                                    let href = originalHref;

                                    // è·³è¿‡å¤–éƒ¨é“¾æ¥
                                    if (!href || href.startsWith("http")) {
                                        console.log(
                                            `[${index}] è·³è¿‡: ${originalHref}`,
                                            {
                                                åŸå› : "å¤–éƒ¨é“¾æ¥",
                                                è¯­è¨€: currentLang,
                                            },
                                        );
                                        skippedCount++;
                                        return;
                                    }
                                    // è·³è¿‡å·²æœ‰è¯­è¨€çš„é“¾æ¥
                                    if (
                                        !href ||
                                        href.startsWith("#/en") ||
                                        href.startsWith("#/es") ||
                                        href.startsWith("#/zh-cn")
                                    ) {
                                        console.log(
                                            `[${index}] è·³è¿‡: ${originalHref}`,
                                            {
                                                åŸå› : "å·²æœ‰è¯­è¨€å‰ç¼€",
                                                è¯­è¨€: currentLang,
                                            },
                                        );
                                        skippedCount++;
                                        return;
                                    }

                                    // æ¸…ç†é“¾æ¥æ ¼å¼
                                    href = href.replace(/^#?\/?/, "");

                                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ è¯­è¨€å‰ç¼€
                                    const needsLangPrefix =
                                        !href.startsWith(currentLang + "/") &&
                                        !href.startsWith("zh-cn/") &&
                                        !href.startsWith("en/") &&
                                        !href.startsWith("es/");

                                    if (needsLangPrefix) {
                                        const newHref =
                                            currentLang + "/" + href;
                                        link.setAttribute(
                                            "href",
                                            "#/" + newHref,
                                        );
                                        fixedCount++;

                                        console.log(`[${index}] ä¿®å¤å®Œæˆ:`, {
                                            åŸå§‹: originalHref,
                                            å¤„ç†å: "#/" + newHref,
                                            è¯­è¨€: currentLang,
                                            æ“ä½œ: "æ·»åŠ è¯­è¨€å‰ç¼€",
                                        });

                                        // è°ƒè¯•æ ‡è®°ï¼ˆå¯é€‰ï¼‰
                                        // link.style.outline = '2px solid #42b983';
                                        link.title = `å·²ä¿®å¤: ${originalHref} â†’ ${newHref}`;
                                    } else {
                                        // å·²æœ‰è¯­è¨€å‰ç¼€ä½†å¯èƒ½ç¼ºå°‘ #/
                                        if (!originalHref.startsWith("#/")) {
                                            link.setAttribute(
                                                "href",
                                                "#/" + href,
                                            );
                                            fixedCount++;

                                            console.log(
                                                `[${index}] ä¿®å¤æ ¼å¼:`,
                                                {
                                                    åŸå§‹: originalHref,
                                                    å¤„ç†å: "#/" + href,
                                                    è¯­è¨€: currentLang,
                                                    æ“ä½œ: "æ·»åŠ #/å‰ç¼€",
                                                },
                                            );
                                        } else {
                                            console.log(
                                                `[${index}] æ— éœ€ä¿®æ”¹: ${originalHref}`,
                                                {
                                                    åŸå› : "å·²åŒ…å«æ­£ç¡®è¯­è¨€å‰ç¼€",
                                                    è¯­è¨€: currentLang,
                                                },
                                            );
                                            skippedCount++;
                                        }
                                    }
                                });

                                console.log(`ä¾§è¾¹æ é“¾æ¥ä¿®å¤ç»Ÿè®¡:`, {
                                    æ€»é“¾æ¥æ•°: links.length,
                                    å·²ä¿®å¤: fixedCount,
                                    å·²è·³è¿‡: skippedCount,
                                    å½“å‰è¯­è¨€: currentLang,
                                });
                            }
                        });
                    },
                ],
            };

            // è¯­è¨€åˆ‡æ¢å™¨
            function addLanguageSwitcher() {
                if (document.querySelector(".language-switcher")) {
                    return;
                }

                const languages = [
                    { code: "zh-cn", name: "ğŸ‡¨ğŸ‡³ ä¸­æ–‡", path: "#/zh-cn/" },
                    { code: "en", name: "ğŸ‡ºğŸ‡¸ English", path: "#/en/" },
                    { code: "es", name: "ğŸ‡ªğŸ‡¸ EspaÃ±ol", path: "#/es/" },
                ];

                const currentLang = getCurrentLanguage();

                const switcher = document.createElement("div");
                switcher.className = "language-switcher";
                switcher.innerHTML = `
        <select class="lang-select">
          ${languages
              .map(
                  (lang) => `
            <option value="${lang.path}" ${currentLang === lang.code ? "selected" : ""}>
              ${lang.name}
            </option>
          `,
              )
              .join("")}
        </select>
      `;

                const select = switcher.querySelector("select");
                select.addEventListener("change", function () {
                    const targetPath = this.value;
                    const selectedLang = languages.find(
                        (l) => l.path === targetPath,
                    );

                    if (selectedLang) {
                        localStorage.setItem(
                            "docsify-preferred-language",
                            selectedLang.code,
                        );
                        window.location.href = targetPath;
                    }
                });

                const nav = document.querySelector(".app-nav");
                if (nav) {
                    nav.appendChild(switcher);
                }
                console.log("current lang: ", currentLang);
            }

            // æ‹¦æˆªæ–‡ä»¶è¯·æ±‚,è‡ªåŠ¨æ·»åŠ è¯­è¨€å‰ç¼€
            // æ›¿æ¢åŸæœ‰çš„ XHR æ‹¦æˆªä»£ç 
            (function () {
                const originalOpen = XMLHttpRequest.prototype.open;

                XMLHttpRequest.prototype.open = function (method, url) {
                    // æ¯æ¬¡è¯·æ±‚æ—¶å®æ—¶è·å–å½“å‰è¯­è¨€
                    const currentLang = getCurrentLanguage();

                    if (url && typeof url === "string" && url.includes(".md")) {
                        console.log("[XHRæ‹¦æˆª]", {
                            åŸå§‹URL: url,
                            å½“å‰è¯­è¨€: currentLang,
                            æ—¶é—´: new Date().toISOString(),
                        });
                        // ç‰¹æ®Šæ–‡ä»¶å¤„ç†
                        if (
                            url === "/_sidebar.md" ||
                            url === "/_navbar.md" ||
                            url === "/_coverpage.md" ||
                            url === "/README.md"
                        ) {
                            url = "/" + currentLang + url;
                            console.log(`ç‰¹æ®Šæ–‡ä»¶å¤„ç†: ${url}`);
                        }
                        // æ™®é€šæ–‡ä»¶å¤„ç†
                        else if (!url.startsWith("http")) {
                            // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ä¸”ä¸åŒ…å«ä»»ä½•è¯­è¨€å‰ç¼€
                            const hasAnyLangPrefix =
                                url.includes("/zh-cn/") ||
                                url.includes("/en/") ||
                                url.includes("/es/");

                            if (!hasAnyLangPrefix) {
                                // ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
                                if (url.startsWith("/")) {
                                    url = "/" + currentLang + url;
                                } else {
                                    url = "/" + currentLang + "/" + url;
                                }
                            }
                        }
                        console.log("[XHRæ‹¦æˆª]", {
                            å¤„ç†åURL: url,
                            // 'æ˜¯å¦ä¿®æ”¹': originalUrl !== url
                        });
                    }

                    return originalOpen.call(this, method, url);
                };
            })();
        </script>

        <!-- Docsify æ ¸å¿ƒ -->
        <script src="//cdn.jsdelivr.net/npm/docsify/lib/docsify.min.js"></script>

        <!-- æ’ä»¶ -->
        <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/zoom-image.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/docsify-copy-code/dist/docsify-copy-code.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
        <!-- æ ·å¼ -->
        <style>
            .language-switcher {
                display: inline-block;
                margin-left: 20px;
            }

            .lang-select {
                padding: 6px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: white;
                color: #333;
                font-size: 14px;
                cursor: pointer;
                outline: none;
                transition: all 0.3s ease;
            }

            .lang-select:hover {
                border-color: #42b983;
            }

            .lang-select:focus {
                border-color: #42b983;
                box-shadow: 0 0 0 2px rgba(66, 185, 131, 0.2);
            }

            @media (max-width: 768px) {
                .language-switcher {
                    margin: 10px 0;
                    width: 100%;
                }

                .lang-select {
                    width: 100%;
                }
            }
        </style>
    </body>
</html>
