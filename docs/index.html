<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="description" content="Hugo Focus Theme Documentation" />
        <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
        />
        <title>Hugo Focus</title>

        <!-- æµè§ˆå™¨å›¾æ ‡ -->
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

        <!-- é»˜è®¤ä¸»é¢˜ -->
        <link
            rel="stylesheet"
            href="//cdn.jsdelivr.net/npm/docsify/lib/themes/vue.css"
        />
    </head>

    <body>
        <div id="app">æ­£åœ¨åŠ è½½æ–‡æ¡£...</div>

        <script>
            // è·å–å½“å‰å®Œæ•´url
            const MAIN_URL = window.location.href;

            // æ£€æµ‹æ˜¯å¦åœ¨ GitHub Pages ä¸Šè¿è¡Œ
            const isGitHubPages =
                window.location.hostname === "caoyang2002.github.io";
            const REPO_NAME = "hugo-focus"; // GitHub ä»“åº“åç§°

            // è·å–åŸºç¡€è·¯å¾„
            const getBaseUrl = (url) => {
                const hashIndex = url.indexOf("#");
                if (hashIndex !== -1) {
                    return url.substring(0, hashIndex);
                }
                return url;
            };

            const BASE_URL = getBaseUrl(MAIN_URL);
            console.log("BASE_URL:", BASE_URL);
            console.log("æ˜¯å¦åœ¨ GitHub Pages:", isGitHubPages);
            console.log("ä»“åº“åç§°:", REPO_NAME);

            // è·å–å½“å‰è¯­è¨€
            function getCurrentLanguage() {
                const hash = window.location.hash;

                // æ–¹æ¡ˆ1ï¼šæ›´ç²¾ç¡®çš„åŒ¹é…
                const match = hash.match(/^#\/(zh-cn|en|es)(\/|$)/);
                if (match && match[1]) {
                    return match[1];
                }

                // æ–¹æ¡ˆ2ï¼šä½¿ç”¨ includes
                if (hash.startsWith("#/en/") || hash === "#/en") return "en";
                if (hash.startsWith("#/es/") || hash === "#/es") return "es";
                if (hash.startsWith("#/zh-cn/") || hash === "#/zh-cn")
                    return "zh-cn";

                // é»˜è®¤å€¼
                return "zh-cn";
            }

            // è·å–åŸºç¡€è·¯å¾„å‰ç¼€
            function getBasePath() {
                if (isGitHubPages) {
                    return `/${REPO_NAME}/`;
                }
                return "/";
            }

            window.$docsify = {
                loadNavbar: true,
                debug: true,
                // é¡¹ç›®ä¿¡æ¯
                name: "Hugo Focus",
                repo: "https://github.com/caoyang2002/hugo-focus",

                // è®¾ç½®åŸºç¡€è·¯å¾„ - è¿™æ˜¯å…³é”®ï¼
                basePath: isGitHubPages ? `/${REPO_NAME}/` : "/",

                // é¦–é¡µé…ç½®
                homepage: function () {
                    const currentLang = getCurrentLanguage();
                    return `${currentLang}/README.md`;
                },

                // åˆ«åé…ç½®
                alias: {
                    "/_sidebar.md": `/_sidebar.md`,
                    "/_navbar.md": `/_navbar.md`,
                    "/_coverpage.md": `/_coverpage.md`,
                    "/README.md": function () {
                        const lang = getCurrentLanguage();
                        return `/${lang}/README.md`;
                    },
                },

                // åŠ è½½é…ç½®
                loadSidebar: true,
                loadNavbar: true,
                coverpage: true,

                // æœç´¢é…ç½®
                search: {
                    maxAge: 86400000,
                    paths: "auto",
                    placeholder: {
                        "/zh-cn/": "æœç´¢",
                        "/en/": "Search",
                        "/es/": "Buscar",
                    },
                    noData: {
                        "/zh-cn/": "æ‰¾ä¸åˆ°ç»“æœ",
                        "/en/": "No results found",
                        "/es/": "No se encontraron resultados",
                    },
                    depth: 3,
                    namespace: "hugo-focus-docs",
                },

                // å…¶ä»–é…ç½®
                maxLevel: 5,
                subMaxLevel: 4,
                sidebarDisplayLevel: 1,
                mergeNavbar: true,
                auto2top: true,
                relativePath: true, // å¯ç”¨ç›¸å¯¹è·¯å¾„

                // è‡ªå®šä¹‰æ’ä»¶
                plugins: [
                    // åˆå§‹åŒ–å’Œé‡å®šå‘æ’ä»¶
                    function (hook, vm) {
                        hook.init(function () {
                            console.log("[åˆå§‹åŒ–æ’ä»¶] å¼€å§‹æ‰§è¡Œ");

                            setTimeout(function () {
                                const hash = window.location.hash;
                                const browserLang = (
                                    navigator.language || navigator.userLanguage
                                ).toLowerCase();
                                const savedLang = localStorage.getItem(
                                    "docsify-preferred-language",
                                );

                                let targetLang = savedLang || "zh-cn";
                                if (!savedLang) {
                                    if (browserLang.startsWith("en"))
                                        targetLang = "en";
                                    else if (browserLang.startsWith("es"))
                                        targetLang = "es";
                                }

                                console.log("[åˆå§‹åŒ–æ’ä»¶]", {
                                    hash: hash,
                                    browserLang: browserLang,
                                    savedLang: savedLang,
                                    targetLang: targetLang,
                                });

                                // åªæœ‰å½“å®Œå…¨æ²¡æœ‰hashæˆ–hashä¸ºç©ºæ—¶æ‰é‡å®šå‘
                                if (!hash || hash === "#/" || hash === "#") {
                                    const newHash = "#/" + targetLang + "/";
                                    window.location.hash = newHash;
                                    console.log(
                                        "[åˆå§‹åŒ–æ’ä»¶] é‡å®šå‘åˆ°:",
                                        newHash,
                                    );
                                }
                                // å¦‚æœhashä¸­ä¸åŒ…å«ä»»ä½•è¯­è¨€å‰ç¼€
                                else if (
                                    !hash.includes("/zh-cn/") &&
                                    !hash.includes("/en/") &&
                                    !hash.includes("/es/")
                                ) {
                                    const cleanHash = hash.replace(/^#\/?/, "");
                                    // ä¿ç•™å¯èƒ½å­˜åœ¨çš„é”šç‚¹
                                    const parts = cleanHash.split("#");
                                    let newHash =
                                        "#/" + targetLang + "/" + parts[0];
                                    if (parts[1]) {
                                        newHash += "#" + parts[1];
                                    }
                                    window.location.hash = newHash;
                                    console.log(
                                        "[åˆå§‹åŒ–æ’ä»¶] æ·»åŠ è¯­è¨€å‰ç¼€:",
                                        newHash,
                                    );
                                }
                            }, 100);
                        });

                        hook.mounted(function () {
                            console.log(
                                "[åˆå§‹åŒ–æ’ä»¶] DOMå·²åŠ è½½ï¼Œæ·»åŠ è¯­è¨€åˆ‡æ¢å™¨",
                            );
                            // å»¶è¿Ÿæ·»åŠ è¯­è¨€åˆ‡æ¢å™¨ï¼Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
                            setTimeout(addLanguageSwitcher, 500);
                        });

                        hook.doneEach(function () {
                            // æ¯æ¬¡è·¯ç”±å˜åŒ–åæ›´æ–°è¯­è¨€åˆ‡æ¢å™¨
                            setTimeout(addLanguageSwitcher, 100);
                        });
                    },

                    // è‡ªåŠ¨ä¿®æ­£é“¾æ¥æ’ä»¶
                    function (hook, vm) {
                        hook.doneEach(function () {
                            const currentLang = getCurrentLanguage();
                            console.log(
                                "[é“¾æ¥ä¿®å¤æ’ä»¶] å½“å‰è¯­è¨€:",
                                currentLang,
                            );

                            // ä¿®æ­£ä¾§è¾¹æ é“¾æ¥
                            const sidebar =
                                document.querySelector(".sidebar-nav");
                            if (sidebar) {
                                const links =
                                    sidebar.querySelectorAll("a[href]");

                                links.forEach((link) => {
                                    const originalHref =
                                        link.getAttribute("href");
                                    let href = originalHref;

                                    // è·³è¿‡å¤–éƒ¨é“¾æ¥
                                    if (!href || href.startsWith("http"))
                                        return;

                                    // è·³è¿‡å·²æœ‰å®Œæ•´è¯­è¨€å‰ç¼€çš„é“¾æ¥
                                    if (
                                        href.startsWith("#/en/") ||
                                        href.startsWith("#/es/") ||
                                        href.startsWith("#/zh-cn/")
                                    ) {
                                        return;
                                    }

                                    // æ¸…ç†é“¾æ¥æ ¼å¼
                                    href = href.replace(/^#?\/?/, "");

                                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ è¯­è¨€å‰ç¼€
                                    const needsLangPrefix =
                                        !href.startsWith(currentLang + "/") &&
                                        !href.startsWith("zh-cn/") &&
                                        !href.startsWith("en/") &&
                                        !href.startsWith("es/");

                                    if (needsLangPrefix) {
                                        const newHref =
                                            currentLang + "/" + href;
                                        link.setAttribute(
                                            "href",
                                            "#/" + newHref,
                                        );
                                    } else if (!originalHref.startsWith("#/")) {
                                        // å·²æœ‰è¯­è¨€å‰ç¼€ä½†å¯èƒ½ç¼ºå°‘ #/
                                        link.setAttribute("href", "#/" + href);
                                    }
                                });
                            }

                            // ä¿®æ­£å¯¼èˆªæ é“¾æ¥
                            const navLinks =
                                document.querySelectorAll(".app-nav a[href]");
                            navLinks.forEach((link) => {
                                const href = link.getAttribute("href");
                                if (
                                    href &&
                                    href.startsWith("#/") &&
                                    !href.startsWith("#/en/") &&
                                    !href.startsWith("#/es/") &&
                                    !href.startsWith("#/zh-cn/")
                                ) {
                                    const newHref =
                                        currentLang + href.substring(2);
                                    link.setAttribute("href", "#/" + newHref);
                                }
                            });
                        });
                    },
                ],
            };

            // XHR æ‹¦æˆª - ä¿®å¤æ–‡ä»¶è¯·æ±‚
            (function () {
                const originalOpen = XMLHttpRequest.prototype.open;
                const originalSend = XMLHttpRequest.prototype.send;

                XMLHttpRequest.prototype.open = function (
                    method,
                    url,
                    async,
                    user,
                    password,
                ) {
                    // ä¿å­˜åŸå§‹ URL ä»¥ä¾¿åç»­ä½¿ç”¨
                    this._docsifyOriginalUrl = url;

                    // åªå¤„ç† markdown æ–‡ä»¶
                    if (url && typeof url === "string" && url.endsWith(".md")) {
                        const currentLang = getCurrentLanguage();
                        const basePath = getBasePath();

                        console.log("[XHRæ‹¦æˆª] åŸå§‹URL:", url);

                        // ç‰¹æ®Šæ–‡ä»¶å¤„ç†
                        if (
                            url === "_sidebar.md" ||
                            url === "_navbar.md" ||
                            url === "_coverpage.md" ||
                            url === "README.md"
                        ) {
                            url = `${currentLang}/${url}`;
                        }
                        // æ™®é€š markdown æ–‡ä»¶
                        else if (!url.startsWith("http")) {
                            // å¦‚æœURLå·²ç»åŒ…å«è¯­è¨€å‰ç¼€ï¼Œä¿æŒä¸å˜
                            const hasLangPrefix =
                                url.includes("zh-cn/") ||
                                url.includes("en/") ||
                                url.includes("es/");

                            if (!hasLangPrefix) {
                                // æ·»åŠ è¯­è¨€å‰ç¼€
                                url = `${currentLang}/${url}`;
                            }
                        }

                        // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ä¸”ä¸åœ¨ GitHub Pages ä¸Šï¼Œæ·»åŠ åŸºç¡€è·¯å¾„
                        if (!url.startsWith("http") && !url.startsWith("/")) {
                            url = basePath + url;
                        } else if (
                            !url.startsWith("http") &&
                            url.startsWith("/") &&
                            isGitHubPages
                        ) {
                            // ç¡®ä¿åœ¨ GitHub Pages ä¸Šæœ‰æ­£ç¡®çš„è·¯å¾„
                            if (!url.startsWith(basePath)) {
                                url = basePath + url.substring(1);
                            }
                        }

                        console.log("[XHRæ‹¦æˆª] å¤„ç†åURL:", url);
                    }

                    return originalOpen.call(
                        this,
                        method,
                        url,
                        async,
                        user,
                        password,
                    );
                };
            })();

            // è¯­è¨€åˆ‡æ¢å™¨
            function addLanguageSwitcher() {
                if (document.querySelector(".language-switcher")) {
                    return;
                }

                const languages = [
                    { code: "zh-cn", name: "ğŸ‡¨ğŸ‡³ ä¸­æ–‡", path: "#/zh-cn/" },
                    { code: "en", name: "ğŸ‡ºğŸ‡¸ English", path: "#/en/" },
                    { code: "es", name: "ğŸ‡ªğŸ‡¸ EspaÃ±ol", path: "#/es/" },
                ];

                const currentLang = getCurrentLanguage();

                const switcher = document.createElement("div");
                switcher.className = "language-switcher";
                switcher.innerHTML = `
                    <select class="lang-select">
                        ${languages
                            .map(
                                (lang) => `
                            <option value="${lang.path}" ${currentLang === lang.code ? "selected" : ""}>
                                ${lang.name}
                            </option>
                        `,
                            )
                            .join("")}
                    </select>
                `;

                const select = switcher.querySelector("select");
                select.addEventListener("change", function () {
                    const targetPath = this.value;
                    const selectedLang = languages.find(
                        (l) => l.path === targetPath,
                    );

                    if (selectedLang) {
                        localStorage.setItem(
                            "docsify-preferred-language",
                            selectedLang.code,
                        );
                        window.location.href = targetPath;
                    }
                });

                const nav = document.querySelector(".app-nav");
                if (nav) {
                    nav.appendChild(switcher);
                }
            }

            // åˆå§‹æ·»åŠ è¯­è¨€åˆ‡æ¢å™¨
            document.addEventListener("DOMContentLoaded", function () {
                setTimeout(addLanguageSwitcher, 1000);
            });
        </script>
        <!-- Docsify æ ¸å¿ƒ -->
        <script src="//cdn.jsdelivr.net/npm/docsify/lib/docsify.min.js"></script>

        <!-- æ’ä»¶ -->
        <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/zoom-image.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/docsify-copy-code/dist/docsify-copy-code.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
        <!-- æ ·å¼ -->
        <style>
            .language-switcher {
                display: inline-block;
                margin-left: 20px;
            }

            .lang-select {
                padding: 6px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: white;
                color: #333;
                font-size: 14px;
                cursor: pointer;
                outline: none;
                transition: all 0.3s ease;
            }

            .lang-select:hover {
                border-color: #42b983;
            }

            .lang-select:focus {
                border-color: #42b983;
                box-shadow: 0 0 0 2px rgba(66, 185, 131, 0.2);
            }

            @media (max-width: 768px) {
                .language-switcher {
                    margin: 10px 0;
                    width: 100%;
                }

                .lang-select {
                    width: 100%;
                }
            }
        </style>
    </body>
</html>
