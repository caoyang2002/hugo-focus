{{/* layouts/partials/wordcloud.html */}}

<!-- 词云容器 -->
<div class="my-8 relative">
    <!-- 3D 词云容器 -->
    <div
        id="wordcloud-3d-container"
        class="w-full h-[500px] border border-gray-800 rounded-lg overflow-hidden bg-gradient-to-br from-gray-900 via-gray-800 to-black hidden"
    >
        <!-- 3D 加载提示 -->
        <div
            id="loading-overlay-3d"
            class="absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm z-10"
        >
            <div class="text-center">
                <div
                    class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"
                ></div>
                <p class="text-white text-lg font-medium">加载 3D 词云中...</p>
                <p class="text-gray-400 text-sm mt-2">首次加载可能需要几秒钟</p>
            </div>
        </div>
    </div>

    <!-- 2D 词云容器 -->
    <div
        id="wordcloud-2d-container"
        class="w-full h-[500px] border border-gray-300 rounded-lg overflow-hidden bg-white"
    >
        <!-- 2D 加载提示 -->
        <div
            id="loading-overlay-2d"
            class="absolute inset-0 flex items-center justify-center bg-white/90 backdrop-blur-sm z-10"
        >
            <div class="text-center">
                <div
                    class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-4"
                ></div>
                <p class="text-gray-700 text-lg font-medium">加载词云中...</p>
            </div>
        </div>
    </div>

    <!-- 控制面板 -->
    <div
        id="control-panel"
        class="absolute top-4 left-4 bg-white/10 backdrop-blur-md rounded-lg p-3 shadow-lg z-10 border border-white/20 hidden"
    >
        <div class="flex flex-col space-y-2">
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-white">模式:</span>
                <button
                    id="toggle-mode"
                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition"
                >
                    3D
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-white">旋转:</span>
                <button
                    id="toggle-rotation"
                    class="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded transition"
                >
                    开启
                </button>
            </div>
        </div>
    </div>

    <!-- 提示信息 -->
    <div
        id="hint"
        class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/70 text-white text-sm px-4 py-2 rounded-full backdrop-blur-sm border border-white/20 hidden"
    >
        <span class="flex items-center">
            <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"
                ></path>
            </svg>
            点击词云查看详情
        </span>
    </div>
</div>

<!-- 加载 2D 词云库 -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>

<script>
    // 安全的词云数据获取
    function getWordCloudData() {
        // 尝试从 Hugo 模板获取标签数据
        try {
            {{ if .Site.Taxonomies.tags }}
            const hugoData = [
                {{ range $tag, $count := .Site.Taxonomies.tags }}
                { text: '{{ replace $tag "'" "\\'" }}', size: {{ len $count }}, weight: {{ len $count }} },
                {{ end }}
            ];
            // 按权重排序，取前 1000 个
            return hugoData
                .sort((a, b) => b.weight - a.weight)
                .slice(0, 1000);
            {{ else }}
            return getDefaultData();
            {{ end }}
        } catch (error) {
            console.warn('获取 Hugo 数据失败:', error);
            return getDefaultData();
        }
    }

    function getDefaultData() {
        return [
            { text: 'Hugo', size: 25, weight: 25 },
            { text: 'GoLang', size: 20, weight: 20 },
            { text: 'JavaScript', size: 18, weight: 18 },
            { text: 'CSS3', size: 16, weight: 16 },
            { text: 'HTML5', size: 14, weight: 14 },
            { text: '前端开发', size: 22, weight: 22 },
            { text: '后端开发', size: 20, weight: 20 },
            { text: '全栈开发', size: 18, weight: 18 },
            { text: '云计算', size: 15, weight: 15 },
            { text: '大数据', size: 13, weight: 13 },
            { text: 'AI', size: 17, weight: 17 },
            { text: '机器学习', size: 16, weight: 16 },
            { text: '深度学习', size: 14, weight: 14 },
            { text: '算法', size: 12, weight: 12 },
            { text: '数据结构', size: 10, weight: 10 },
            { text: 'Python', size: 19, weight: 19 },
            { text: 'Java', size: 17, weight: 17 },
            { text: 'C++', size: 15, weight: 15 },
            { text: 'Rust', size: 13, weight: 13 },
            { text: 'TypeScript', size: 21, weight: 21 }
        ];
    }

    // 2D 词云实现
    class WordCloud2D {
        constructor(containerId) {
            this.container = document.getElementById(containerId);
            this.loadingOverlay = document.getElementById('loading-overlay-2d');
            this.canvas = null;
            this.isInitialized = false;

            if (!this.container) {
                console.error('找不到 2D 词云容器');
                return;
            }

            this.init();
        }

        init() {
            console.log('初始化 2D 词云...');

            // 确保 WordCloud2 已加载
            if (typeof WordCloud === 'undefined') {
                console.error('WordCloud2.js 未加载');
                this.showError('词云库加载失败');
                return;
            }

            const wordData = getWordCloudData();
            console.log('2D 词云数据:', wordData.length, '个词');

            // 转换为 WordCloud2 需要的格式
            const wordList = wordData.map(item => [item.text, item.weight * 10]);

            // 设置画布
            this.canvas = document.createElement('canvas');

             const devicePixelRatio = window.devicePixelRatio || 1;
             // 获取容器尺寸
                 const containerWidth = this.container.clientWidth;
                 const containerHeight = this.container.clientHeight;

                 // 设置画布的逻辑尺寸（CSS 尺寸）
                 this.canvas.style.width = containerWidth + 'px';
                 this.canvas.style.height = containerHeight + 'px';

                 // 设置画布的实际像素尺寸（乘以设备像素比）
                 this.canvas.width = containerWidth * devicePixelRatio;
                 this.canvas.height = containerHeight * devicePixelRatio;

                 this.container.appendChild(this.canvas);

            // 调整容器大小
            const width = this.container.clientWidth;
            const height = this.container.clientHeight;
            this.canvas.width = width;
            this.canvas.height = height;

            try {
                // 创建 2D 词云
                WordCloud(this.canvas, {
                    list: wordList,
                    gridSize: Math.round(8 * width / 1024),
                    weightFactor: function(size) {
                        return Math.max(size * width / 2000, 10);
                    },
                    fontFamily: 'Arial, "Microsoft YaHei", sans-serif',
                    color: function(word, weight) {
                        // 根据权重设置颜色
                        const hue = (weight * 137) % 360;
                        return `hsl(${hue}, 70%, 50%)`;
                    },
                    backgroundColor: '#ffffff',
                    rotateRatio: 0.5,
                    rotationSteps: 2,
                    minRotation: -45,
                    maxRotation: 45,
                    ellipticity: 0.65,
                    shuffle: true,
                    shape: 'circle',
                    drawOutOfBound: false,
                    shrinkToFit: true,
                    hover: function(item, dimension, event) {
                        if (!item) return;
                        event.target.style.cursor = 'pointer';
                        event.target.title = item[0] + ' (权重: ' + (item[1] / 10) + ')';
                    }
                });

                this.isInitialized = true;
                console.log('2D 词云初始化成功');

                // 隐藏加载提示
                if (this.loadingOverlay) {
                    this.loadingOverlay.style.display = 'none';
                }

                // 添加点击事件
                this.canvas.addEventListener('click', (event) => {
                    this.showHint('点击词云查看详情');
                });

            } catch (error) {
                console.error('2D 词云创建失败:', error);
                this.showError('词云创建失败');
            }
        }
        // 添加 resize 方法，确保分辨率适应窗口变化
        resize() {
            if (!this.isInitialized || !this.canvas) return;

            const devicePixelRatio = window.devicePixelRatio || 1;
            const containerWidth = this.container.clientWidth;
            const containerHeight = this.container.clientHeight;

            // 保存当前的词云列表
            const wordData = getWordCloudData();
            const wordList = wordData.map(item => [item.text, item.weight * 10]);

            // 更新画布尺寸
            this.canvas.style.width = containerWidth + 'px';
            this.canvas.style.height = containerHeight + 'px';
            this.canvas.width = containerWidth * devicePixelRatio;
            this.canvas.height = containerHeight * devicePixelRatio;

            // 清空画布
            const ctx = this.canvas.getContext('2d');
            ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            // 重新绘制词云
            WordCloud(this.canvas, {
                list: wordList,
                gridSize: Math.round(24 * devicePixelRatio),
                weightFactor: function(size) {
                    return Math.max(size * devicePixelRatio * 15, 20);
                },
                fontFamily: 'Arial, "Microsoft YaHei", sans-serif',
                color: function(word, weight) {
                    const hue = (weight * 137) % 360;
                    return `hsl(${hue}, 75%, 50%)`;
                },
                backgroundColor: '#ffffff',
                rotateRatio: 0.5,
                rotationSteps: 4,
                minRotation: -45,
                maxRotation: 45,
                ellipticity: 0.65,
                shuffle: true,
                shape: 'circle',
                drawOutOfBound: false,
                shrinkToFit: true
            });

            // 调整 Canvas 上下文
            ctx.scale(devicePixelRatio, devicePixelRatio);

            console.log('词云已重绘，新分辨率:', this.canvas.width, 'x', this.canvas.height);
        }

        showHint(message) {
            const hint = document.getElementById('hint');
            if (hint) {
                const originalText = hint.innerHTML;
                hint.innerHTML = `
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ${message}
                    </span>
                `;

                hint.classList.remove('hidden');

                setTimeout(() => {
                    if (hint) {
                        hint.innerHTML = originalText;
                    }
                }, 2000);
            }
        }

        showError(message) {
            if (this.loadingOverlay) {
                this.loadingOverlay.innerHTML = `
                    <div class="text-center">
                        <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-700 font-medium">${message}</p>
                        <p class="text-gray-500 text-sm mt-2">请刷新页面重试</p>
                    </div>
                `;
            }
        }

        resize() {
            if (!this.isInitialized || !this.canvas) return;

            const width = this.container.clientWidth;
            const height = this.container.clientHeight;
            this.canvas.width = width;
            this.canvas.height = height;

            // 这里可以重新绘制词云，但 WordCloud2 需要完整的重新初始化
            // 可以保存配置然后重新创建
        }
    }

    // 3D 词云实现
    class WordCloud3D {
        constructor(containerId) {
            this.container = document.getElementById(containerId);
            this.loadingOverlay = document.getElementById('loading-overlay-3d');

            if (!this.container) {
                console.error('找不到 3D 词云容器');
                return;
            }

            // 检查 Three.js 是否加载
            if (typeof THREE === 'undefined') {
                console.error('Three.js 未加载');
                throw new Error('Three.js 未加载');
            }

            this.init();
        }

        init() {
            console.log('初始化 3D 词云...');

            try {
                // Three.js 初始化代码...
                // 这里可以保留之前的 3D 代码，但先使用 2D 作为回退

                // 暂时隐藏 3D 容器，显示 2D
                this.container.classList.add('hidden');
                document.getElementById('wordcloud-2d-container').classList.remove('hidden');

                // 显示提示
                this.showHint('3D 模式暂不可用，已切换到 2D 模式');

            } catch (error) {
                console.error('3D 词云初始化失败:', error);
                throw error;
            }
        }

        showHint(message) {
            const hint = document.getElementById('hint');
            if (hint) {
                hint.innerHTML = `
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ${message}
                    </span>
                `;
                hint.classList.remove('hidden');

                setTimeout(() => {
                    if (hint) {
                        hint.classList.add('hidden');
                    }
                }, 3000);
            }
        }
    }

    // 主控制器
    class WordCloudController {
        constructor() {
            this.mode = '2d'; // '2d' 或 '3d'
            this.wordCloud2D = null;
            this.wordCloud3D = null;
            this.isInitialized = false;

            this.init();
        }

        init() {
            console.log('初始化词云控制器...');

            // 初始化 2D 词云（默认模式）
            this.initialize2DWordCloud();

            // 延迟初始化 3D（按需加载）
            setTimeout(() => this.tryInitialize3D(), 100);

            // 绑定控制面板事件
            this.bindEvents();
        }

        initialize2DWordCloud() {
            try {
                this.wordCloud2D = new WordCloud2D('wordcloud-2d-container');
                this.showControlPanel();
                this.showHint('已加载 2D 词云');
            } catch (error) {
                console.error('2D 词云初始化失败:', error);
                this.showError('词云加载失败');
            }
        }

        tryInitialize3D() {
            // 按需加载 Three.js
            const threeScript = document.createElement('script');
            threeScript.src = 'https://unpkg.com/three@0.164.1/build/three.min.js';
            threeScript.onload = () => {
                // Three.js 加载成功，可以尝试初始化 3D
                console.log('Three.js 加载成功');

                // 加载 OrbitControls
                const orbitScript = document.createElement('script');
                orbitScript.src = 'https://unpkg.com/three@0.164.1/examples/js/controls/OrbitControls.js';
                orbitScript.onload = () => {
                    console.log('OrbitControls 加载成功');
                    // 现在可以切换到 3D 模式
                    document.getElementById('toggle-mode').textContent = '3D';
                };
                orbitScript.onerror = () => {
                    console.warn('OrbitControls 加载失败');
                };
                document.head.appendChild(orbitScript);
            };
            threeScript.onerror = () => {
                console.warn('Three.js 加载失败，将使用 2D 模式');
            };
            document.head.appendChild(threeScript);
        }

        bindEvents() {
            // 使用事件委托，避免元素不存在的问题
            document.addEventListener('click', (event) => {
                if (!event.target) return;

                if (event.target.id === 'toggle-mode') {
                    this.toggleMode();
                } else if (event.target.id === 'toggle-rotation') {
                    this.toggleRotation();
                }
            });

            // 窗口大小变化
            window.addEventListener('resize', () => {
                if (this.wordCloud2D && this.mode === '2d') {
                    this.wordCloud2D.resize();
                }
            });
        }

        toggleMode() {
            if (this.mode === '2d') {
                // 切换到 3D
                this.switchTo3D();
            } else {
                // 切换到 2D
                this.switchTo2D();
            }
        }

        switchTo3D() {
            // 隐藏 2D，显示 3D
            document.getElementById('wordcloud-2d-container').classList.add('hidden');
            document.getElementById('wordcloud-3d-container').classList.remove('hidden');

            // 尝试初始化 3D
            try {
                if (!this.wordCloud3D) {
                    this.wordCloud3D = new WordCloud3D('wordcloud-3d-container');
                }
                this.mode = '3d';
                document.getElementById('toggle-mode').textContent = '2D';
                this.showHint('已切换到 3D 模式');
            } catch (error) {
                console.error('切换到 3D 失败:', error);
                // 切换回 2D
                this.switchTo2D();
                this.showHint('3D 模式不可用，已切换回 2D');
            }
        }

        switchTo2D() {
            // 隐藏 3D，显示 2D
            document.getElementById('wordcloud-3d-container').classList.add('hidden');
            document.getElementById('wordcloud-2d-container').classList.remove('hidden');

            this.mode = '2d';
            document.getElementById('toggle-mode').textContent = '3D';
            this.showHint('已切换到 2D 模式');
        }

        toggleRotation() {
            // 这里可以控制 3D 旋转，暂时不实现
            const button = document.getElementById('toggle-rotation');
            button.textContent = button.textContent === '开启' ? '关闭' : '开启';
            this.showHint(`自动旋转: ${button.textContent}`);
        }

        showControlPanel() {
            const controlPanel = document.getElementById('control-panel');
            const hint = document.getElementById('hint');
            if (controlPanel) controlPanel.classList.remove('hidden');
            if (hint) hint.classList.remove('hidden');
        }

        showHint(message) {
            const hint = document.getElementById('hint');
            if (hint) {
                hint.innerHTML = `
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ${message}
                    </span>
                `;
                hint.classList.remove('hidden');

                setTimeout(() => {
                    if (hint) {
                        hint.classList.add('hidden');
                    }
                }, 2000);
            }
        }

        showError(message) {
            // 显示错误信息
            const containers = [
                'wordcloud-2d-container',
                'wordcloud-3d-container'
            ];

            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-700">
                            <svg class="w-16 h-16 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-xl font-bold mb-2">加载失败</h3>
                            <p class="text-gray-600">${message}</p>
                        </div>
                    `;
                }
            });
        }
    }

    // 主初始化函数
    function initializeWordCloud() {
        console.log('开始初始化词云系统...');

        // 等待必要的 DOM 元素加载
        const checkInterval = setInterval(() => {
            const container2D = document.getElementById('wordcloud-2d-container');
            const container3D = document.getElementById('wordcloud-3d-container');

            if (container2D && container3D) {
                clearInterval(checkInterval);

                try {
                    window.wordCloudController = new WordCloudController();
                    console.log('词云系统初始化完成');
                } catch (error) {
                    console.error('词云系统初始化失败:', error);
                    // 显示错误
                    if (container2D) {
                        container2D.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-gray-700">
                                <svg class="w-16 h-16 text-yellow-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.346 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 class="text-xl font-bold mb-2">词云加载失败</h3>
                                <p class="text-gray-600">请刷新页面重试</p>
                            </div>
                        `;
                    }
                }
            }
        }, 100);

        // 10秒后超时
        setTimeout(() => {
            clearInterval(checkInterval);
            const container2D = document.getElementById('wordcloud-2d-container');
            if (container2D && !window.wordCloudController) {
                container2D.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-700">
                        <svg class="w-16 h-16 text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="text-xl font-bold mb-2">初始化超时</h3>
                        <p class="text-gray-600">请检查网络连接后刷新页面</p>
                    </div>
                `;
            }
        }, 10000);
    }

    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWordCloud);
    } else {
        initializeWordCloud();
    }

    // 全局暴露控制器
    window.wordCloudController = null;
</script>

<style>
    #wordcloud-2d-container,
    #wordcloud-3d-container {
        width: 100%;
        height: 500px;
        position: relative;
    }

    #wordcloud-2d-container canvas {
        display: block;
        width: 100%;
        height: 100%;
    }

    /* 控制面板样式 */
    #control-panel {
        transition: all 0.3s ease;
    }

    #control-panel:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    #hint {
        transition: all 0.3s ease;
        pointer-events: none;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        #wordcloud-2d-container,
        #wordcloud-3d-container {
            height: 400px;
        }

        #control-panel {
            transform: scale(0.85);
            transform-origin: top left;
        }

        #hint {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
        }
    }

    @media (max-width: 480px) {
        #wordcloud-2d-container,
        #wordcloud-3d-container {
            height: 350px;
        }

        #control-panel {
            transform: scale(0.75);
        }
    }
</style>
