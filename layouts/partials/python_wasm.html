{{/* layouts/partials/python-wasm.html */}}
<!--  -->
{{ if .Params.pythonWasm }}
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<script>
    let pyodideInstance = null;

    async function initPyodide() {
        if (!pyodideInstance) {
            try {
                pyodideInstance = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/",
                });
                // 初始化标准输出捕获
                await pyodideInstance.runPythonAsync(`
        import sys
        from io import StringIO
      `);
            } catch (error) {
                console.error("Pyodide initialization failed:", error);
            }
        }
        return pyodideInstance;
    }

    async function runPythonCode(code, outputElement) {
        try {
            // 确保 Pyodide 已初始化
            const pyodide = await initPyodide();
            if (!pyodide) {
                throw new Error("Pyodide failed to initialize");
            }

            // 创建新的输出缓冲区
            await pyodide.runPythonAsync(`
      sys.stdout = StringIO()
    `);

            // 运行用户代码
            await pyodide.runPythonAsync(code);

            // 获取输出
            const output = await pyodide.runPythonAsync(
                "sys.stdout.getvalue()",
            );
            outputElement.textContent = output || "(无输出)";
            outputElement.parentElement.style.display = "block";
        } catch (error) {
            outputElement.textContent = `错误: ${error.message}`;
            outputElement.parentElement.style.display = "block";
            console.error("Python execution error:", error);
        }
    }

    // 等待 DOM 加载完成
    document.addEventListener("DOMContentLoaded", () => {
        // 初始化所有 Python 代码块
        document
            .querySelectorAll(".python-playground")
            .forEach((playground) => {
                const runButton = playground.querySelector(".run-button");
                const codeElement = playground.querySelector("code");
                const outputElement =
                    playground.querySelector(".output-content");

                runButton.addEventListener("click", async () => {
                    runButton.disabled = true;
                    runButton.textContent = "运行中...";
                    outputElement.parentElement.style.display = "none";

                    try {
                        await runPythonCode(
                            codeElement.textContent,
                            outputElement,
                        );
                    } finally {
                        runButton.disabled = false;
                        runButton.textContent = "运行";
                    }
                });
            });
    });
</script>

<style>
    .python-playground {
        margin: 1.5em 0;
        border: 1px solid #ddd;
        border-radius: 0.5em;
        overflow: hidden;
    }

    .python-playground .code-wrapper {
        margin: 0;
        padding: 1em;
        background: var(--bg-code, #f8f9fa);
    }

    .python-playground .controls {
        padding: 0.5em;
        border-top: 1px solid #ddd;
        background: #f8f9fa;
    }

    .python-playground .run-button {
        padding: 0.25em 1em;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 0.25em;
        cursor: pointer;
    }

    .python-playground .run-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .python-playground .output {
        padding: 1em;
        border-top: 1px solid #ddd;
        background: #f8f9fa;
    }

    .python-playground .output pre {
        margin: 0;
        white-space: pre-wrap;
    }

    /* 深色模式支持 */
    @media (prefers-color-scheme: dark) {
        .python-playground {
            border-color: #444;
        }

        .python-playground .code-wrapper {
            background: var(--bg-code-dark, #2d2d2d);
        }

        .python-playground .controls,
        .python-playground .output {
            background: #2d2d2d;
            border-color: #444;
        }
    }
</style>
{{ end }}
