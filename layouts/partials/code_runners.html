<!-- 代码运行器 -->
{{/* layouts/partials/code_runners.html */}}
<!-- x -->
{{ if .Params.codeRunners }}
<script>
    // 添加 loadScript 工具函数
    async function loadScript(src, timeout = 10000) {
        return new Promise((resolve, reject) => {
            if (!src) {
                resolve();
                return;
            }

            const existingScript = document.querySelector(
                `script[src="${src}"]`,
            );
            if (existingScript) {
                resolve();
                return;
            }

            const script = document.createElement("script");
            script.src = src;
            script.async = true;

            // 添加超时处理
            const timeoutId = setTimeout(() => {
                script.remove();
                reject(new Error(`Script loading timed out: ${src}`));
            }, timeout);

            script.onload = () => {
                clearTimeout(timeoutId);
                resolve();
            };

            script.onerror = (e) => {
                clearTimeout(timeoutId);
                script.remove();
                console.error(`Failed to load script: ${src}`, e);
                reject(new Error(`脚本加载失败: ${src}`));
            };

            document.head.appendChild(script);
        });
    }

    // 支持的语言运行时配置
    const runners = {
        // wasm
        python: {
            cdn: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js",
            init: async () => {
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/",
                });
                await pyodide.loadPackage(["numpy", "pandas"]);
                return pyodide;
            },
            execute: async (code) => {
                try {
                    let output = [];
                    const pyodide = runtimeInstances.python;
                    // 重定向 Python 的打印输出
                    pyodide.globals.set("print", (s) => output.push(s));
                    const result = await pyodide.runPythonAsync(code);
                    return output.join("\n") || String(result);
                } catch (error) {
                    throw new Error(`Python execution error: ${error.message}`);
                }
            },
        },

        //Playground
        rust: {
            cdn: null,
            init: async () => {
                // 简单返回一个空对象，因为我们不需要特殊的初始化
                return {};
            },
            execute: async (code) => {
                try {
                    const response = await fetch(
                        "https://play.rust-lang.org/execute",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                channel: "stable",
                                mode: "debug",
                                edition: "2021",
                                crateType: "bin",
                                tests: false,
                                code: code,
                            }),
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const result = await response.json();
                    if (result.success) {
                        return result.stdout || "(无输出)";
                    } else {
                        throw new Error(result.stderr);
                    }
                } catch (error) {
                    if (error.message.includes("Failed to fetch")) {
                        throw new Error(
                            "无法连接到 Rust Playground。请检查网络连接。",
                        );
                    }
                    throw new Error(`Rust 执行错误: ${error.message}`);
                }
            },
        },

        // wasm and Playground
        go: {
            cdn: "https://cdn.jsdelivr.net/gh/golang/go@go1.21.1/misc/wasm/wasm_exec.js",
            init: async () => {
                try {
                    const go = new Go();
                    return { instance: go };
                } catch (error) {
                    throw new Error(
                        `Go runtime initialization error: ${error.message}`,
                    );
                }
            },
            execute: async (code) => {
                try {
                    // 首先修复代码格式
                    const fixedCode = code
                        .replace("package\n", "package main\n")
                        .replace("print", "Println");

                    // 使用 Go Playground API
                    const response = await fetch(
                        "https://play.golang.org/compile",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/x-www-form-urlencoded",
                            },
                            body: `version=2&body=${encodeURIComponent(fixedCode)}&withVet=true`,
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const result = await response.json();

                    if (result.Errors) {
                        throw new Error(result.Errors);
                    }

                    // 返回结果
                    return (
                        result.Events.map((event) => event.Message).join(
                            "\n",
                        ) || "(无输出)"
                    );
                } catch (error) {
                    if (error.message.includes("Failed to fetch")) {
                        throw new Error(
                            "无法连接到 Go Playground。请检查网络连接。",
                        );
                    }
                    throw new Error(`Go 执行错误: ${error.message}`);
                }
            },
        },

        // TypeScript 的 JavaScript 实现
        typescript: {
            cdn: "https://cdn.jsdelivr.net/npm/typescript@latest/lib/typescript.min.js",
            init: async () => {
                await loadScript(
                    "https://cdn.jsdelivr.net/npm/typescript@latest/lib/typescript.min.js",
                );
                return window.ts;
            },
            execute: async (code) => {
                try {
                    // 捕获控制台输出
                    let output = [];
                    const originalLog = console.log;
                    console.log = (...args) => {
                        output.push(args.join(" "));
                    };

                    const jsCode = ts.transpileModule(code, {
                        compilerOptions: {
                            target: ts.ScriptTarget.ES2015,
                            module: ts.ModuleKind.None,
                            strictNullChecks: true,
                        },
                    }).outputText;

                    eval(jsCode);

                    // 恢复控制台
                    console.log = originalLog;
                    return output.join("\n");
                } catch (e) {
                    throw new Error(
                        `TypeScript compilation/execution error: ${e.message}`,
                    );
                }
            },
        },
        ts: {
            cdn: null,
            init: async () => {
                return runners.typescript.init();
            },
            execute: async (code) => {
                return runners.typescript.execute(code);
            },
        },

        // 原生 JavaScript - 修复了 execute 方法
        javascript: {
            cdn: null,
            init: async () => {
                return window;
            },
            execute: async (code) => {
                try {
                    let output = [];
                    const originalConsoleLog = console.log;
                    const originalConsoleError = console.error;
                    const originalConsoleWarn = console.warn;

                    // 捕获控制台输出
                    console.log = (...args) => {
                        output.push(args.join(" "));
                        originalConsoleLog.apply(console, args);
                    };

                    console.error = (...args) => {
                        output.push("错误: " + args.join(" "));
                        originalConsoleError.apply(console, args);
                    };

                    console.warn = (...args) => {
                        output.push("警告: " + args.join(" "));
                        originalConsoleWarn.apply(console, args);
                    };

                    // 执行 JavaScript 代码
                    let result;
                    try {
                        // 使用 Function 构造函数安全执行
                        const func = new Function(code);
                        result = func();

                        // 如果有返回值但不是 undefined，添加到输出
                        if (result !== undefined) {
                            output.push("返回值: " + result);
                        }
                    } catch (e) {
                        output.push("执行错误: " + e.message);
                        throw e;
                    } finally {
                        // 恢复原始控制台方法
                        console.log = originalConsoleLog;
                        console.error = originalConsoleError;
                        console.warn = originalConsoleWarn;
                    }

                    return output.join("\n") || "(无输出)";
                } catch (error) {
                    throw new Error(
                        `JavaScript execution error: ${error.message}`,
                    );
                }
            },
        },
        js: {
            cdn: null,
            init: async () => {
                return runners.javascript.init();
            },
            execute: async (code) => {
                return runners.javascript.execute(code);
            },
        },

        // JavaScript 实现的 Common Lisp (JSCL) 解释器
        // Common Lisp (JSCL) 运行时 - 使用稳定版本 1.1.1
        lisp: {
            cdn: "https://unpkg.com/jscl@0.8.2/jscl.js",
            init: async () => {
                try {
                    await loadScript("https://unpkg.com/jscl@0.8.2/jscl.js");

                    // 调试：检查 JSCL 对象结构
                    console.log(
                        "JSCL 加载成功，对象结构:",
                        Object.keys(window.jscl),
                    );
                    console.log("JSCL 版本:", window.jscl.version);

                    // 测试是否工作
                    try {
                        const testResult =
                            window.jscl.evaluateString("(+ 1 2)");
                        console.log("JSCL 测试 (+ 1 2) =", testResult);
                    } catch (e) {
                        console.warn("JSCL 测试失败:", e);
                    }

                    return window.jscl;
                } catch (error) {
                    throw new Error(
                        `Lisp runtime initialization error: ${error.message}`,
                    );
                }
            },
            execute: async (code) => {
                try {
                    const lisp = runtimeInstances.lisp;
                    const outputLines = [];

                    // 创建一个专门的输出函数
                    const captureOutput = (message) => {
                        // 过滤掉调试信息
                        if (typeof message === "string" && message.trim()) {
                            // 不捕获 jscl.js 的内部日志
                            if (
                                !message.includes("jscl.js:") &&
                                !message.includes("loading") &&
                                !message.includes("elapsed time")
                            ) {
                                outputLines.push(message.trim());
                            }
                        }
                    };

                    // 保存并替换 console.log
                    const originalConsoleLog = console.log;
                    console.log = (...args) => {
                        captureOutput(args.join(" "));
                        originalConsoleLog.apply(console, args);
                    };

                    // 保存并替换 console.info（JSCL 可能使用这个）
                    const originalConsoleInfo = console.info;
                    console.info = (...args) => {
                        captureOutput(args.join(" "));
                        originalConsoleInfo.apply(console, args);
                    };

                    try {
                        // 执行代码
                        const result = lisp.evaluateString(code);

                        // 处理结果
                        let output = outputLines.join("\n").trim();

                        if (output) {
                            return output;
                        } else if (result !== undefined && result !== null) {
                            if (result === false) {
                                // Lisp 的 NIL 返回为 false
                                return "NIL";
                            } else {
                                return String(result);
                            }
                        } else {
                            return "(无输出)";
                        }
                    } finally {
                        // 恢复原始控制台函数
                        console.log = originalConsoleLog;
                        console.info = originalConsoleInfo;
                    }
                } catch (error) {
                    throw new Error(`Lisp execution error: ${error.message}`);
                }
            },
        },
        // Ruby WASM 运行时
        ruby: {
            cdn: "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@latest/dist/browser.umd.js",
            init: async () => {
                try {
                    // 加载 Ruby WASM 运行时
                    await loadScript(
                        "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@latest/dist/browser.umd.js",
                    );

                    // 加载 WASM 模块
                    const wasmUrl =
                        "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@latest/dist/ruby.wasm";

                    // 初始化 Ruby VM
                    const { RubyVM } = window;
                    const response = await fetch(wasmUrl);
                    const buffer = await response.arrayBuffer();

                    const vm = new RubyVM();
                    await vm.initialize({
                        wasi: new window.WASI({
                            version: "preview1",
                            env: {},
                            args: [],
                        }),
                    });

                    // 设置输出捕获
                    let output = [];
                    vm.print = (str) => {
                        output.push(str);
                    };

                    // 保存输出捕获函数
                    vm._output = output;

                    return vm;
                } catch (error) {
                    console.error("Detailed Ruby init error:", error);
                    throw new Error(
                        `Ruby runtime initialization error: ${error.message}`,
                    );
                }
            },
            execute: async (code) => {
                try {
                    const vm = runtimeInstances.ruby;

                    // 清空之前的输出
                    if (vm._output) {
                        vm._output.length = 0;
                    }

                    // 执行代码
                    await vm.eval(code);

                    // 获取输出
                    const output = vm._output || [];
                    return output.join("\n") || "(No output)";
                } catch (error) {
                    console.error("Ruby execution error details:", error);
                    throw new Error(`Ruby execution error: ${error.message}`);
                }
            },
        },

        // Swift WASM 运行时
        swift: {
            cdn: "https://cdn.jsdelivr.net/npm/swiftwasm@5.9.2/dist/index.js",
            init: async () => {
                try {
                    await loadScript(
                        "https://cdn.jsdelivr.net/npm/swiftwasm@5.9.2/dist/index.js",
                    );

                    // 初始化 Swift WASM 运行时
                    const swift = await window.SwiftWasm.initialize({
                        stdio: {
                            write: (text) => console.log("Swift output:", text),
                        },
                    });

                    return swift;
                } catch (error) {
                    console.error("Swift initialization error:", error);
                    throw new Error(
                        `Swift runtime initialization error: ${error.message}`,
                    );
                }
            },
            execute: async (code) => {
                try {
                    const swift = runtimeInstances.swift;
                    let output = "";

                    // 重定向输出
                    swift.setStdout((text) => {
                        output += text;
                    });

                    // 执行代码
                    await swift.run(code);

                    return output.trim() || "(No output)";
                } catch (error) {
                    console.error("Swift execution error:", error);
                    throw new Error(`Swift execution error: ${error.message}`);
                }
            },
        },

        // playground
        cpp: {
            cdn: null,
            init: async () => {
                return true;
            },
            execute: async (code) => {
                try {
                    const response = await fetch(
                        "https://godbolt.org/api/compiler/g132/compile",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Accept: "application/json",
                            },
                            body: JSON.stringify({
                                source: code,
                                options: {
                                    userArguments: "-std=c++17",
                                    executeParameters: {
                                        args: [],
                                        stdin: "",
                                    },
                                    compilerOptions: {
                                        executorRequest: true,
                                    },
                                },
                            }),
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `Compilation failed with status: ${response.status}`,
                        );
                    }

                    const result = await response.json();

                    if (result.code !== 0) {
                        throw new Error(
                            result.stderr || "Unknown compilation error",
                        );
                    }

                    const output =
                        result.stdout.map((item) => item.text).join("\n") || "";
                    const error = result.stderr || "";
                    const exitCode = result.code || 0;
                    const data = `输出: ${output}\n错误：${error}\n退出码: ${exitCode}`;
                    console.log(data);

                    return data;
                } catch (error) {
                    throw new Error(`C++ execution error: ${error.message}`);
                }
            },
        },

        // Java (TeaVM) 运行时
        java: {
            cdn: "https://teavm.org/js/teavm.js",
            init: async () => {
                try {
                    await loadScript("https://teavm.org/js/teavm.js");

                    // 等待 TeaVM 加载完成
                    await new Promise((resolve) => {
                        const checkTeaVM = () => {
                            if (window.TeaVM) {
                                resolve();
                            } else {
                                setTimeout(checkTeaVM, 100);
                            }
                        };
                        checkTeaVM();
                    });

                    // 初始化 TeaVM
                    const java = await window.TeaVM.init({
                        classpath: [],
                        mainClass: null,
                    });

                    return java;
                } catch (error) {
                    console.error("Java initialization error:", error);
                    throw new Error(
                        `Java runtime initialization error: ${error.message}`,
                    );
                }
            },
            execute: async (code) => {
                try {
                    const java = runtimeInstances.java;

                    // 创建一个简单的 Java 类
                    const javaCode = `
                    import java.io.*;

                    public class Runner {
                        public static void main(String[] args) {
                            try {
                                // 重定向 System.out
                                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                                PrintStream ps = new PrintStream(baos);
                                PrintStream old = System.out;
                                System.setOut(ps);

                                // 执行用户代码
                                ${code}

                                // 恢复 System.out
                                System.out.flush();
                                System.setOut(old);
                                System.out.println(baos.toString());
                            } catch (Exception e) {
                                e.printStackTrace();
                            }
                        }
                    }
                    `;

                    // 编译并执行 Java 代码
                    const result = await java.compileAndRun(javaCode, "Runner");
                    return result || "(No output)";
                } catch (error) {
                    console.error("Java execution error:", error);
                    throw new Error(`Java execution error: ${error.message}`);
                }
            },
        },
    };

    // 添加 Rust WASM 编译和运行函数
    async function compileAndRunRustWasm(code) {
        // 添加必要的 WASM 导入
        const rustCode = `
        #[no_mangle]
        pub extern "C" fn run() {
            ${code}
        }
        `;

        try {
            // 使用 rust-wasm 工具链编译代码
            const wasmModule = await window.rustc.compile(rustCode, {
                target: "wasm32-unknown-unknown",
                release: false,
            });

            // 创建 WASM 实例
            const instance = await WebAssembly.instantiate(wasmModule, {
                env: {
                    memory: new WebAssembly.Memory({ initial: 256 }),
                    abort: () => console.log("Rust 程序中止"),
                },
            });

            // 捕获输出
            let output = "";
            const originalConsoleLog = console.log;
            console.log = (...args) => {
                output += args.join(" ") + "\n";
            };

            // 运行 WASM 代码
            instance.exports.run();

            // 恢复 console.log
            console.log = originalConsoleLog;

            return output || "(无输出)";
        } catch (error) {
            throw new Error(`Rust WASM 编译/执行错误: ${error.message}`);
        }
    }

    let runtimeInstances = {};

    async function initRuntime(language) {
        console.log("初始化运行时:", language);
        if (!runners[language]) {
            throw new Error(`不支持的语言: ${language}`);
        }
        console.log("开始实例化运行时");
        try {
            if (!runtimeInstances[language]) {
                const runner = runners[language];
                if (runner.cdn) {
                    await loadScript(runner.cdn);
                }
                runtimeInstances[language] = await runner.init();
            }
            console.log("实例化成功");
            return runtimeInstances[language];
        } catch (error) {
            console.error(
                `Runtime initialization error for ${language}:`,
                error,
            );
            throw new Error(`运行时初始化失败: ${error.message}`);
        }
    }

    // 执行代码
    async function executeCode(language, code, outputElement) {
        try {
            console.log("执行代码：", language);
            const runtime = await initRuntime(language);
            let result;

            if (runners[language].execute) {
                result = await runners[language].execute(code);
            } else {
                throw new Error(`${language} 没有实现执行方法`);
            }

            outputElement.textContent = result;
            outputElement.parentElement.style.display = "block";
        } catch (error) {
            console.error(`Code execution error for ${language}:`, error);
            outputElement.textContent = `错误: ${error.message}`;
            outputElement.parentElement.style.display = "block";
        }
    }

    // 初始化代码编辑器
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".code-playground").forEach((playground) => {
            const language = playground.getAttribute("data-language");
            const runButton = playground.querySelector(".run-button"); // 运行按钮
            const codeElement = playground.querySelector("code");
            const outputElement = playground.querySelector(".output-content");

            runButton.addEventListener("click", async () => {
                runButton.disabled = true;
                runButton.textContent = `加载 ${language} 运行时...`;
                outputElement.parentElement.style.display = "none";

                try {
                    await executeCode(
                        language,
                        codeElement.textContent,
                        outputElement,
                    );
                } catch (error) {
                    outputElement.textContent = `运行时错误: ${error.message}`;
                    outputElement.parentElement.style.display = "block";
                } finally {
                    runButton.disabled = false;
                    runButton.textContent = "运行";
                }
            });
        });
    });
</script>

<style>
    .code-playground {
        border: 1px solid #ddd;
        border-radius: 0.5em;
        overflow: hidden;
    }

    .code-playground .controls {
        border: 1px solid #ddd;
        border-radius: 0.5em;
        margin: 1rem;
        border-top: 1px solid #ddd;
    }

    .code-playground .run-button {
        margin: 0.25rem;
        padding: 0rem 4rem;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 0.25em;
        cursor: pointer;
    }

    .code-playground .run-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .code-playground .output {
        border-top: 1px solid #ddd;
        background: #f8f9fa;
        margin: 1rem;
        border: 1px solid #ddd;
        border-radius: 0.5em;
    }

    .code-playground .output pre {
        margin: 0;
        white-space: pre-wrap;
    }

    /* 深色模式支持 */
    @media (prefers-color-scheme: dark) {
        .code-playground {
            border-color: #444;
        }

        .code-playground .code-wrapper {
            background: var(--bg-code-dark, #2d2d2d);
        }

        .code-playground .controls,
        .code-playground .output {
            background: #2d2d2d;
            border-color: #444;
        }
    }
</style>
{{ end }}
