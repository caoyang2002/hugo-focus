<!-- 代码运行器 - 最终优化版 (仅包含可直接运行的语言) -->
{{/* layouts/partials/code_runners.html */}} {{ if .Params.codeRunners }}
<script>
    // ==================== 工具函数 ====================
    async function loadScript(src, timeout = 15000) {
        return new Promise((resolve, reject) => {
            if (!src) {
                resolve();
                return;
            }

            const existingScript = document.querySelector(
                `script[src="${src}"]`,
            );
            if (existingScript) {
                resolve();
                return;
            }

            const script = document.createElement("script");
            script.src = src;
            script.async = true;

            const timeoutId = setTimeout(() => {
                script.remove();
                reject(new Error(`Script loading timed out: ${src}`));
            }, timeout);

            script.onload = () => {
                clearTimeout(timeoutId);
                resolve();
            };

            script.onerror = (e) => {
                clearTimeout(timeoutId);
                script.remove();
                reject(new Error(`Failed to load script: ${src}`));
            };

            document.head.appendChild(script);
        });
    }

    // ==================== 语言运行时配置 ====================
    const runners = {
        // ==================== 1. Python (Pyodide WASM) ====================
        python: {
            cdn: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js",
            init: async () => {
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
                });
                await pyodide.loadPackage(["numpy", "pandas", "matplotlib"]);
                return pyodide;
            },
            execute: async (code) => {
                const pyodide = runtimeInstances.python;
                let output = [];

                pyodide.globals.set("print", (...args) => {
                    output.push(args.map(String).join(" "));
                });

                try {
                    const result = await pyodide.runPythonAsync(code);
                    const resultStr =
                        result !== undefined ? String(result) : "";
                    return (
                        [...output, resultStr].filter(Boolean).join("\n") ||
                        "(无输出)"
                    );
                } catch (error) {
                    throw new Error(`Python错误: ${error.message}`);
                }
            },
        },
        py: {
            cdn: null,
            init: async () => runners.python.init(),
            execute: async (code) => runners.python.execute(code),
        },

        // =================== R (WASM) ====================
        r: {
            // 使用稳定的版本，例如 v0.3.1
            cdn: "https://webr.r-wasm.org/v0.3.1/webr.mjs",
            init: async () => {
                try {
                    // 动态导入指定版本的WebR
                    const { WebR } =
                        await import("https://webr.r-wasm.org/v0.3.1/webr.mjs");
                    const webR = new WebR();
                    await webR.init();
                    return webR; // 返回初始化的WebR实例
                } catch (error) {
                    console.error("WebR 初始化失败:", error);
                    throw new Error(
                        `R runtime initialization error: ${error.message}`,
                    );
                }
            },
            execute: async (code) => {
                try {
                    const webR = runtimeInstances.r;

                    // 创建一个Shelter来管理R对象和捕获输出
                    const shelter = await new webR.Shelter();
                    // 关键：使用 captureR 执行代码并捕获所有输出[citation:7]
                    const result = await shelter.captureR(code);

                    // 清理Shelter，释放内存
                    shelter.purge();

                    // 处理捕获到的输出：将 stdout 数据连接成字符串
                    if (result.output && result.output.length > 0) {
                        // 筛选出标准输出流，并合并内容
                        const outputText = result.output
                            .filter((line) => line.type === "stdout")
                            .map((line) => line.data)
                            .join("\n")
                            .trim();
                        return outputText || "(无输出)";
                    }
                    return "(无输出)";
                } catch (error) {
                    console.error("R 执行错误:", error);
                    throw new Error(`R execution error: ${error.message}`);
                }
            },
        },

        // =================== 2. JavaScript (原生) ====================
        javascript: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                let output = [];
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;

                console.log = (...args) => {
                    output.push(args.map(String).join(" "));
                    originalLog.apply(console, args);
                };
                console.error = (...args) => {
                    output.push("错误: " + args.map(String).join(" "));
                    originalError.apply(console, args);
                };
                console.warn = (...args) => {
                    output.push("警告: " + args.map(String).join(" "));
                    originalWarn.apply(console, args);
                };

                try {
                    const func = new Function(code);
                    const result = func();
                    if (result !== undefined) {
                        output.push("返回值: " + result);
                    }
                } catch (e) {
                    throw new Error(`执行错误: ${e.message}`);
                } finally {
                    console.log = originalLog;
                    console.error = originalError;
                    console.warn = originalWarn;
                }

                return output.join("\n") || "(无输出)";
            },
        },
        js: {
            cdn: null,
            init: async () => runners.javascript.init(),
            execute: async (code) => runners.javascript.execute(code),
        },

        // ==================== 3. TypeScript ====================
        typescript: {
            cdn: "https://cdn.jsdelivr.net/npm/typescript@5.3.3/lib/typescript.min.js",
            init: async () => {
                await loadScript(
                    "https://cdn.jsdelivr.net/npm/typescript@5.3.3/lib/typescript.min.js",
                );
                return window.ts;
            },
            execute: async (code) => {
                let output = [];
                const originalLog = console.log;
                console.log = (...args) => output.push(args.join(" "));

                try {
                    const jsCode = ts.transpileModule(code, {
                        compilerOptions: {
                            target: ts.ScriptTarget.ES2020,
                            module: ts.ModuleKind.None,
                        },
                    }).outputText;

                    eval(jsCode);
                } catch (e) {
                    throw new Error(`TypeScript错误: ${e.message}`);
                } finally {
                    console.log = originalLog;
                }

                return output.join("\n") || "(无输出)";
            },
        },
        ts: {
            cdn: null,
            init: async () => runners.typescript.init(),
            execute: async (code) => runners.typescript.execute(code),
        },

        // ==================== 4. Rust (Playground API) ====================
        rust: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://play.rust-lang.org/execute",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            channel: "stable",
                            mode: "debug",
                            edition: "2021",
                            crateType: "bin",
                            tests: false,
                            code: code,
                        }),
                    },
                );

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    return result.stdout || "(无输出)";
                } else {
                    throw new Error(result.stderr || "编译失败");
                }
            },
        },
        rs: {
            cdn: null,
            init: async () => runners.rust.init(),
            execute: async (code) => runners.rust.execute(code),
        },

        // ==================== 5. Go (Playground API) ====================
        go: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://play.golang.org/compile",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: `version=2&body=${encodeURIComponent(code)}&withVet=true`,
                    },
                );

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                const result = await response.json();
                if (result.Errors) {
                    throw new Error(result.Errors);
                }

                return (
                    result.Events?.map((e) => e.Message).join("\n") ||
                    "(无输出)"
                );
            },
        },

        // ==================== 6. C (Godbolt API) ====================
        c: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://godbolt.org/api/compiler/cg132/compile",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            source: code,
                            options: {
                                userArguments: "-std=c17 -O2",
                                executeParameters: { args: [], stdin: "" },
                                compilerOptions: { executorRequest: true },
                            },
                        }),
                    },
                );

                if (!response.ok) {
                    throw new Error(`编译失败: ${response.status}`);
                }

                const result = await response.json();
                if (result.code !== 0) {
                    throw new Error(result.stderr || "执行失败");
                }

                const output =
                    result.stdout?.map((item) => item.text).join("\n") || "";
                return output || "(无输出)";
            },
        },

        // ==================== 7. C++ (Godbolt API) ====================
        cpp: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://godbolt.org/api/compiler/g132/compile",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            source: code,
                            options: {
                                userArguments: "-std=c++20 -O2",
                                executeParameters: { args: [], stdin: "" },
                                compilerOptions: { executorRequest: true },
                            },
                        }),
                    },
                );

                if (!response.ok) {
                    throw new Error(`编译失败: ${response.status}`);
                }

                const result = await response.json();
                if (result.code !== 0) {
                    throw new Error(result.stderr || "执行失败");
                }

                const output =
                    result.stdout?.map((item) => item.text).join("\n") || "";
                return output || "(无输出)";
            },
        },

        // ==================== 8. PHP (Wandbox API) ====================
        php: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "php-8.3.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },

        // ==================== 9. Ruby (Wandbox API) ====================
        ruby: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "ruby-3.3.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        rb: {
            cdn: null,
            init: async () => runners.ruby.init(),
            execute: async (code) => runners.ruby.execute(code),
        },

        // ==================== 10. Swift (Wandbox API) ====================
        swift: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "swift-5.9.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },

        // ==================== 11. Kotlin (官方 Playground API) ====================
        kotlin: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://api.kotlinlang.org/api/1.9.21/compiler/run",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            args: "",
                            confType: "java",
                            files: [
                                { name: "File.kt", text: code, publicId: null },
                            ],
                        }),
                    },
                );

                const result = await response.json();
                if (result.errors?.length > 0) {
                    throw new Error(
                        result.errors.map((e) => e.message).join("\n"),
                    );
                }

                return result.text || "(无输出)";
            },
        },
        kt: {
            cdn: null,
            init: async () => runners.kotlin.init(),
            execute: async (code) => runners.kotlin.execute(code),
        },

        // ==================== 12. Scala (Wandbox API) ====================
        scala: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "scala-3.3.1",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },

        // ==================== 13. Haskell (Wandbox API) ====================
        haskell: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "ghc-9.6.3",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        hs: {
            cdn: null,
            init: async () => runners.haskell.init(),
            execute: async (code) => runners.haskell.execute(code),
        },

        // ==================== 14. Perl (Wandbox API) ====================
        perl: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "perl-5.38.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        pl: {
            cdn: null,
            init: async () => runners.perl.init(),
            execute: async (code) => runners.perl.execute(code),
        },

        // ==================== 15. Lua (Fengari WASM) ====================
        lua: {
            cdn: "https://fengari.io/fengari-web.js",
            init: async () => {
                await loadScript("https://fengari.io/fengari-web.js");
                return fengari;
            },
            execute: async (code) => {
                const fengari = runtimeInstances.lua;
                let output = [];

                const L = fengari.lauxlib.luaL_newstate();
                fengari.lauxlib.luaL_openlibs(L);

                fengari.lua.lua_pushcfunction(L, function (L) {
                    const n = fengari.lua.lua_gettop(L);
                    const args = [];
                    for (let i = 1; i <= n; i++) {
                        args.push(fengari.lua.lua_tojsstring(L, i));
                    }
                    output.push(args.join("\t"));
                    return 0;
                });
                fengari.lua.lua_setglobal(L, "print");

                const result = fengari.lauxlib.luaL_dostring(L, code);
                if (result !== 0) {
                    const err = fengari.lua.lua_tojsstring(L, -1);
                    throw new Error(err);
                }

                return output.join("\n") || "(无输出)";
            },
        },

        // ==================== 16. Zig (Wandbox API) ====================
        zig: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "zig-0.11.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },

        // ==================== 17. Nim (Wandbox API) ====================
        nim: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "nim-2.0.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },

        // ==================== 18. D (Wandbox API) ====================
        d: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "dmd-2.105.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },

        // ==================== 19. Fortran (Wandbox API) ====================
        fortran: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "gfortran-13.2.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        f90: {
            cdn: null,
            init: async () => runners.fortran.init(),
            execute: async (code) => runners.fortran.execute(code),
        },

        // ==================== 20. SQL (SQL.js WASM) ====================
        sql: {
            cdn: "https://cdn.jsdelivr.net/npm/sql.js@1.10.0/dist/sql-wasm.js",
            init: async () => {
                await loadScript(
                    "https://cdn.jsdelivr.net/npm/sql.js@1.10.0/dist/sql-wasm.js",
                );
                return await initSqlJs({
                    locateFile: (file) =>
                        `https://cdn.jsdelivr.net/npm/sql.js@1.10.0/dist/${file}`,
                });
            },
            execute: async (code) => {
                const SQL = runtimeInstances.sql;
                const db = new SQL.Database();
                const output = [];

                const statements = code.split(";").filter((s) => s.trim());

                for (const stmt of statements) {
                    try {
                        if (stmt.trim().toUpperCase().startsWith("SELECT")) {
                            const result = db.exec(stmt);
                            if (result.length > 0) {
                                result.forEach(({ columns, values }) => {
                                    output.push(columns.join(" | "));
                                    output.push(
                                        "-".repeat(columns.join(" | ").length),
                                    );
                                    values.forEach((row) =>
                                        output.push(row.join(" | ")),
                                    );
                                    output.push("");
                                });
                            }
                        } else {
                            db.run(stmt);
                            output.push(
                                `✓ 执行成功: ${stmt.substring(0, 50)}...`,
                            );
                        }
                    } catch (e) {
                        output.push(`✗ 错误: ${e.message}`);
                    }
                }

                return output.join("\n") || "查询完成";
            },
        },

        // ==================== 21. Bash/Shell (模拟) ====================
        bash: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const lines = code.split("\n");
                const output = [];

                for (const line of lines) {
                    const cmd = line.trim();
                    if (!cmd || cmd.startsWith("#")) continue;

                    if (cmd.startsWith("echo ")) {
                        const text = cmd
                            .substring(5)
                            .replace(/^["']|["']$/g, "");
                        output.push(text);
                    } else if (cmd === "pwd") {
                        output.push("/home/user");
                    } else if (cmd.startsWith("ls")) {
                        output.push("file1.txt  file2.txt  directory/");
                    } else if (cmd.startsWith("date")) {
                        output.push(new Date().toString());
                    } else if (cmd.startsWith("whoami")) {
                        output.push("user");
                    } else if (cmd.startsWith("uname")) {
                        output.push("Linux");
                    } else {
                        output.push(`[模拟执行] ${cmd}`);
                    }
                }

                return output.join("\n") || "(无输出)";
            },
        },
        sh: {
            cdn: null,
            init: async () => runners.bash.init(),
            execute: async (code) => runners.bash.execute(code),
        },
        shell: {
            cdn: null,
            init: async () => runners.bash.init(),
            execute: async (code) => runners.bash.execute(code),
        },

        // ==================== 22. Lisp (JSCL) ====================
        lisp: {
            cdn: "https://unpkg.com/jscl@0.8.2/jscl.js",
            init: async () => {
                await loadScript("https://unpkg.com/jscl@0.8.2/jscl.js");
                return window.jscl;
            },
            execute: async (code) => {
                const lisp = runtimeInstances.lisp;
                let output = [];

                const originalLog = console.log;
                console.log = (...args) => {
                    const msg = args.join(" ");
                    if (!msg.includes("jscl.js:") && !msg.includes("loading")) {
                        output.push(msg);
                    }
                };

                try {
                    const result = lisp.evaluateString(code);

                    if (output.length > 0) {
                        return output.join("\n");
                    } else if (result !== undefined && result !== null) {
                        return result === false ? "NIL" : String(result);
                    } else {
                        return "(无输出)";
                    }
                } catch (error) {
                    throw new Error(`Lisp错误: ${error.message}`);
                } finally {
                    console.log = originalLog;
                }
            },
        },

        // ==================== 23. Pascal (Wandbox API) ====================
        pascal: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "fpc-3.2.2",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        pas: {
            cdn: null,
            init: async () => runners.pascal.init(),
            execute: async (code) => runners.pascal.execute(code),
        },

        // ==================== 24. Erlang (Wandbox API) ====================
        erlang: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "erlang-26.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        erl: {
            cdn: null,
            init: async () => runners.erlang.init(),
            execute: async (code) => runners.erlang.execute(code),
        },

        // ==================== 25. Elixir (Wandbox API) ====================
        elixir: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "elixir-1.15.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        ex: {
            cdn: null,
            init: async () => runners.elixir.init(),
            execute: async (code) => runners.elixir.execute(code),
        },

        // ==================== 26. OCaml (Wandbox API) ====================
        ocaml: {
            cdn: null,
            init: async () => ({}),
            execute: async (code) => {
                const response = await fetch(
                    "https://wandbox.org/api/compile.json",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: code,
                            compiler: "ocaml-5.0.0",
                            options: "",
                            stdin: "",
                        }),
                    },
                );

                const result = await response.json();
                if (result.status !== "0") {
                    throw new Error(
                        result.compiler_error ||
                            result.program_error ||
                            "执行失败",
                    );
                }

                return result.program_output || "(无输出)";
            },
        },
        ml: {
            cdn: null,
            init: async () => runners.ocaml.init(),
            execute: async (code) => runners.ocaml.execute(code),
        },

        // ==================== 27. Scheme (BiwaScheme WASM) ====================
        scheme: {
            cdn: "https://unpkg.com/biwascheme@0.8.0/release/biwascheme.min.js",
            init: async () => {
                await loadScript(
                    "https://unpkg.com/biwascheme@0.8.0/release/biwascheme.min.js",
                );
                return new BiwaScheme.Interpreter();
            },
            execute: async (code) => {
                const interpreter = runtimeInstances.scheme;
                let output = [];

                const originalLog = console.log;
                console.log = (...args) => output.push(args.join(" "));

                try {
                    const result = interpreter.evaluate(code);
                    console.log = originalLog;

                    return output.length > 0
                        ? output.join("\n")
                        : String(result);
                } catch (error) {
                    console.log = originalLog;
                    throw new Error(`Scheme错误: ${error.message}`);
                }
            },
        },
        scm: {
            cdn: null,
            init: async () => runners.scheme.init(),
            execute: async (code) => runners.scheme.execute(code),
        },
    };

    // ==================== 运行时管理 ====================
    let runtimeInstances = {};

    async function initRuntime(language) {
        if (!runners[language]) {
            throw new Error(`不支持的语言: ${language}`);
        }

        try {
            if (!runtimeInstances[language]) {
                const runner = runners[language];
                if (runner.cdn) {
                    await loadScript(runner.cdn);
                }
                runtimeInstances[language] = await runner.init();
            }
            return runtimeInstances[language];
        } catch (error) {
            console.error(
                `Runtime initialization error for ${language}:`,
                error,
            );
            throw new Error(`运行时初始化失败: ${error.message}`);
        }
    }

    async function executeCode(language, code, outputElement) {
        try {
            await initRuntime(language);
            const result = await runners[language].execute(code);
            outputElement.textContent = result;
            outputElement.parentElement.style.display = "block";
        } catch (error) {
            console.error(`Code execution error for ${language}:`, error);
            outputElement.textContent = `错误: ${error.message}`;
            outputElement.parentElement.style.display = "block";
        }
    }

    // ==================== 初始化 ====================
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".code-playground").forEach((playground) => {
            const language = playground.getAttribute("data-language");
            const runButton = playground.querySelector(".run-button");
            const codeElement = playground.querySelector("code");
            const outputElement = playground.querySelector(".output-content");

            if (!runButton || !codeElement || !outputElement) {
                console.warn(
                    `Missing elements for playground with language: ${language}`,
                );
                return;
            }

            runButton.addEventListener("click", async () => {
                runButton.disabled = true;
                runButton.textContent = `加载 ${language} 运行时...`;
                outputElement.parentElement.style.display = "none";

                try {
                    await executeCode(
                        language,
                        codeElement.textContent,
                        outputElement,
                    );
                } catch (error) {
                    outputElement.textContent = `运行时错误: ${error.message}`;
                    outputElement.parentElement.style.display = "block";
                } finally {
                    runButton.disabled = false;
                    runButton.textContent = "▶ 运行";
                }
            });
        });
    });
</script>

<style>
    .code-playground {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        margin: 1.5rem 0;
        background: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .code-playground .code-wrapper {
        background: #282c34;
        overflow-x: auto;
    }

    .code-playground .controls {
        padding: 0.75rem;
        border-top: 1px solid #ddd;
        background: #fff;
        text-align: center;
    }

    .code-playground .run-button {
        padding: 0.6rem 3.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .code-playground .run-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .code-playground .run-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .code-playground .output {
        display: none;
        border-top: 1px solid #ddd;
        background: #f8f9fa;
        padding: 1rem;
    }

    .code-playground .output-label {
        font-weight: bold;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .code-playground .output-content {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
        color: #212529;
    }

    /* 滚动条样式 */
    .code-playground .output-content::-webkit-scrollbar {
        width: 8px;
    }

    .code-playground .output-content::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .code-playground .output-content::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .code-playground .output-content::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* 深色模式 */
    @media (prefers-color-scheme: dark) {
        .code-playground {
            background: #1e1e1e;
            border-color: #444;
        }

        .code-playground .controls {
            background: #2d2d2d;
            border-color: #444;
        }

        .code-playground .output {
            background: #2d2d2d;
            border-color: #444;
        }

        .code-playground .output-label {
            color: #e0e0e0;
        }

        .code-playground .output-content {
            background: #1e1e1e;
            border-color: #444;
            color: #e0e0e0;
        }

        .code-playground .output-content::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .code-playground .output-content::-webkit-scrollbar-thumb {
            background: #555;
        }

        .code-playground .output-content::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    }
</style>
{{ end }}
