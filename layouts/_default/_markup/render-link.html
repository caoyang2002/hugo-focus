{{/* layouts/_default/_markup/render-link.html */}}
{{ $isExternal := strings.HasPrefix .Destination "http" }}
{{ $isInternal := not $isExternal }}

<a href="{{ .Destination | safeURL }}"
   {{ with .Title }}title="{{ . }}"{{ end }}
   {{ if $isExternal }}
   target="_blank"
   rel="noopener noreferrer"
   class="external-link"
   data-preview-url="{{ .Destination }}"
   data-preview-type="external"
   {{ else }}
   class="internal-link"
   data-preview-url="{{ .Destination }}"
   data-preview-type="internal"
   {{ end }}>
  {{ .Text | safeHTML }}
  {{ if $isExternal }}
  <span class="external-icon">
    {{ $iconPath := "icon/action/link.svg" }}
    {{ if fileExists (printf "static/%s" $iconPath) }}
    {{ $svgContent := readFile (printf "static/%s" $iconPath) }}
    {{ $styledSvg := replace $svgContent "<svg" `<svg style="display:inline-block;width:0.85em;height:0.85em;vertical-align:middle;fill:currentColor"` }}
    {{ $styledSvg | safeHTML }}
    {{ else }}
    <span>↗</span>
    {{ end }}
  </span>
  {{ end }}
</a>

{{/* 添加预览容器（每个页面只添加一次） */}}
{{ if not (.Page.Scratch.Get "preview_container_added") }}
{{ .Page.Scratch.Set "preview_container_added" true }}
<template id="preview-template">
  <div class="link-preview">
    <div class="preview-loading">
      <div class="loading-spinner"></div>
      <span>加载中...</span>
    </div>
    <div class="preview-content hidden">
      <div class="preview-header">
        <img class="preview-favicon" src="" alt="">
        <div class="preview-title"></div>
        <button class="preview-close" aria-label="关闭">×</button>
      </div>
      <div class="preview-body">
        <div class="preview-image hidden"></div>
        <div class="preview-description"></div>
        <div class="preview-url"></div>
      </div>
      <div class="preview-footer">
        <a class="preview-link" href="">
          <span>访问链接 →</span>
        </a>
      </div>
    </div>
  </div>
</template>
{{ end }}

<style>
  /* 链接样式 */
  .external-link {
    color: #3b82f6;
    text-decoration: underline;
    text-decoration-color: rgba(59, 130, 246, 0.3);
    transition: text-decoration-color 0.2s;
  }

  .external-link:hover {
    text-decoration-color: rgba(59, 130, 246, 0.6);
  }

  .internal-link {
    color: #8b5cf6;
    text-decoration: underline;
    text-decoration-color: rgba(139, 92, 246, 0.3);
    transition: text-decoration-color 0.2s;
  }

  .internal-link:hover {
    text-decoration-color: rgba(139, 92, 246, 0.6);
  }

  .external-icon {
    display: inline-block;
    margin-left: 2px;
    opacity: 0.6;
    font-size: 0.9em;
  }

  /* 预览框样式 */
  .link-preview {
    position: fixed;
    z-index: 9999;
    width: 340px;
    max-width: calc(100vw - 32px);
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 0 1px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    overflow: hidden;
  }

  .link-preview.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .preview-header {
    display: flex;
    align-items: center;
    padding: 12px 14px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    gap: 10px;
  }

  .preview-favicon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    display: none;
  }

  .preview-favicon[src]:not([src=""]) {
    display: block;
  }

  .preview-title {
    flex: 1;
    font-weight: 600;
    font-size: 14px;
    color: #111827;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .preview-close {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #6b7280;
    line-height: 1;
    padding: 2px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    flex-shrink: 0;
    transition: all 0.15s;
  }

  .preview-close:hover {
    background: #e5e7eb;
    color: #111827;
  }

  .preview-body {
    max-height: 350px;
    overflow: hidden;
  }

  .preview-image {
    width: 100%;
    height: 180px;
    overflow: hidden;
    background: #f3f4f6;
  }

  .preview-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .preview-image.hidden {
    display: none;
  }

  .preview-description {
    padding: 14px;
    font-size: 13px;
    line-height: 1.5;
    color: #4b5563;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
  }

  .preview-description:empty {
    display: none;
  }

  .preview-url {
    padding: 0 14px 10px;
    font-size: 12px;
    color: #9ca3af;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .preview-footer {
    padding: 10px 14px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
  }

  .preview-link {
    display: inline-block;
    color: #3b82f6;
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    transition: color 0.15s;
  }

  .preview-link:hover {
    color: #2563eb;
    text-decoration: underline;
  }

  .preview-loading {
    padding: 40px 20px;
    text-align: center;
    color: #6b7280;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .hidden {
    display: none !important;
  }

  /* 暗色模式 */
  @media (prefers-color-scheme: dark) {
    .link-preview {
      background: #1f2937;
      border-color: #374151;
    }

    .preview-header,
    .preview-footer {
      background: #111827;
      border-color: #374151;
    }

    .preview-title {
      color: #f9fafb;
    }

    .preview-description {
      color: #d1d5db;
    }

    .preview-url {
      color: #6b7280;
    }

    .preview-close {
      color: #9ca3af;
    }

    .preview-close:hover {
      background: #374151;
      color: #f9fafb;
    }

    .preview-link {
      color: #60a5fa;
    }

    .preview-link:hover {
      color: #93c5fd;
    }

    .preview-image {
      background: #111827;
    }

    .loading-spinner {
      border-color: #374151;
      border-top-color: #60a5fa;
    }
  }
</style>

<script>
(function() {
  'use strict';

  class LinkPreview {
    constructor() {
      this.preview = null;
      this.showTimer = null;
      this.hideTimer = null;
      this.currentUrl = null;
      this.cache = new Map();
      this.isOverLink = false;
      this.isOverPreview = false;
      this.init();
    }

    init() {
      // 确保只初始化一次
      if (window.linkPreviewInitialized) return;
      window.linkPreviewInitialized = true;

      const template = document.getElementById('preview-template');
      if (!template) return;

      this.preview = template.content.cloneNode(true).firstElementChild;
      document.body.appendChild(this.preview);

      this.bindEvents();
    }

    bindEvents() {
      // 使用事件委托
      document.addEventListener('mouseover', (e) => {
        const link = e.target.closest('a[data-preview-url]');
        if (link) this.handleLinkEnter(link);
      });

      document.addEventListener('mouseout', (e) => {
        const link = e.target.closest('a[data-preview-url]');
        if (link) this.handleLinkLeave();
      });

      // 预览框事件
      this.preview.addEventListener('mouseenter', () => {
        this.isOverPreview = true;
        clearTimeout(this.hideTimer);
      });

      this.preview.addEventListener('mouseleave', () => {
        this.isOverPreview = false;
        this.scheduleHide();
      });

      // 关闭按钮
      this.preview.querySelector('.preview-close').addEventListener('click', () => {
        this.hide();
      });

      // 点击外部关闭
      document.addEventListener('click', (e) => {
        if (!this.preview.contains(e.target)) {
          this.hide();
        }
      });

      // ESC 键关闭
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') this.hide();
      });
    }

    handleLinkEnter(link) {
      this.isOverLink = true;
      clearTimeout(this.showTimer);
      clearTimeout(this.hideTimer);

      this.showTimer = setTimeout(() => {
        if (this.isOverLink) {
          this.show(link);
        }
      }, 300);
    }

    handleLinkLeave() {
      this.isOverLink = false;
      clearTimeout(this.showTimer);
      this.scheduleHide();
    }

    scheduleHide() {
      clearTimeout(this.hideTimer);
      this.hideTimer = setTimeout(() => {
        if (!this.isOverLink && !this.isOverPreview) {
          this.hide();
        }
      }, 150);
    }

    async show(link) {
      const url = link.getAttribute('data-preview-url');
      const type = link.getAttribute('data-preview-type');

      if (!url) return;

      // 相同链接只重新定位
      if (url === this.currentUrl && this.preview.classList.contains('visible')) {
        this.position(link);
        return;
      }

      this.currentUrl = url;
      this.position(link);
      this.showLoading();

      try {
        const data = type === 'internal'
          ? await this.loadInternal(url)
          : this.loadExternal(url);

        this.render(data);
      } catch (err) {
        console.error('Preview error:', err);
        this.hide();
      }
    }

    position(link) {
      const rect = link.getBoundingClientRect();
      const width = 340;
      const margin = 10;

      let top = rect.bottom + window.scrollY + margin;
      let left = rect.left + window.scrollX;

      // 水平调整
      if (left + width > window.innerWidth - margin) {
        left = window.innerWidth - width - margin;
      }
      if (left < margin) {
        left = margin;
      }

      // 垂直调整
      if (rect.bottom + 300 > window.innerHeight) {
        top = rect.top + window.scrollY - 300 - margin;
      }

      this.preview.style.top = `${top}px`;
      this.preview.style.left = `${left}px`;
      this.preview.classList.add('visible');
    }

    async loadInternal(url) {
      // 检查缓存
      if (this.cache.has(url)) {
        return this.cache.get(url);
      }

      try {
        const fullUrl = new URL(url, window.location.origin).href;
        const response = await fetch(fullUrl, {
          method: 'GET',
          headers: { 'Accept': 'text/html' }
        });

        if (!response.ok) throw new Error('Fetch failed');

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const data = {
          title: this.extractTitle(doc),
          description: this.extractDescription(doc),
          image: this.extractImage(doc, fullUrl),
          favicon: this.extractFavicon(doc, fullUrl),
          url: fullUrl
        };

        this.cache.set(url, data);
        return data;
      } catch (err) {
        throw err;
      }
    }

    loadExternal(url) {
      // 外部链接不使用API，仅显示基本信息
      try {
        const urlObj = new URL(url);
        const hostname = urlObj.hostname;

        return {
          title: hostname,
          description: url,
          image: '',
          favicon: `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`,
          url: url
        };
      } catch (err) {
        return {
          title: '外部链接',
          description: url,
          image: '',
          favicon: '',
          url: url
        };
      }
    }

    extractTitle(doc) {
      return doc.querySelector('h1')?.textContent?.trim() ||
             doc.querySelector('meta[property="og:title"]')?.content ||
             doc.querySelector('title')?.textContent?.trim() ||
             '无标题';
    }

    extractDescription(doc) {
      const ogDesc = doc.querySelector('meta[property="og:description"]')?.content;
      const metaDesc = doc.querySelector('meta[name="description"]')?.content;
      const firstP = doc.querySelector('article p, main p, p')?.textContent?.trim();

      return ogDesc || metaDesc || (firstP ? firstP.substring(0, 200) : '');
    }

    extractImage(doc, baseUrl) {
      const ogImage = doc.querySelector('meta[property="og:image"]')?.content;
      const firstImg = doc.querySelector('article img, main img, img')?.src;

      const imgSrc = ogImage || firstImg;
      return imgSrc ? new URL(imgSrc, baseUrl).href : '';
    }

    extractFavicon(doc, baseUrl) {
      const iconLink = doc.querySelector('link[rel*="icon"]')?.href;
      return iconLink ? new URL(iconLink, baseUrl).href : '';
    }

    render(data) {
      this.preview.querySelector('.preview-loading').classList.add('hidden');
      const content = this.preview.querySelector('.preview-content');
      content.classList.remove('hidden');

      // 填充内容
      const favicon = this.preview.querySelector('.preview-favicon');
      if (data.favicon) {
        favicon.src = data.favicon;
        favicon.onerror = () => favicon.style.display = 'none';
      }

      this.preview.querySelector('.preview-title').textContent = data.title;
      this.preview.querySelector('.preview-description').textContent = data.description;
      this.preview.querySelector('.preview-url').textContent = data.url;

      const link = this.preview.querySelector('.preview-link');
      link.href = data.url;

      // 处理图片
      const imgContainer = this.preview.querySelector('.preview-image');
      if (data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        img.alt = data.title;
        img.loading = 'lazy';
        img.onerror = () => imgContainer.classList.add('hidden');
        imgContainer.innerHTML = '';
        imgContainer.appendChild(img);
        imgContainer.classList.remove('hidden');
      } else {
        imgContainer.classList.add('hidden');
      }
    }

    showLoading() {
      this.preview.querySelector('.preview-content').classList.add('hidden');
      this.preview.querySelector('.preview-loading').classList.remove('hidden');
    }

    hide() {
      this.preview.classList.remove('visible');
      this.currentUrl = null;
      this.isOverPreview = false;
      this.isOverLink = false;
      clearTimeout(this.showTimer);
      clearTimeout(this.hideTimer);
    }
  }

  // 初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new LinkPreview());
  } else {
    new LinkPreview();
  }
})();
</script>
